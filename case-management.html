<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>托里县应急管理局｜行政处罚案件管理</title>

  <style>
    :root{
      --bg:#f4f7fb;
      --card:#ffffff;
      --line:#e6eef7;
      --text:#0f172a;
      --muted:#64748b;
      --blue:#0b5fb3;      /* 应急蓝 */
      --blue2:#0a4f95;
      --red:#c81e1e;       /* 警示红 */
      --orange:#d97706;
      --green:#15803d;
      --shadow: 0 10px 30px rgba(2, 32, 71, .08);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: "Microsoft YaHei","PingFang SC","Noto Sans SC",system-ui,-apple-system,Segoe UI,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 500px at 20% -10%, rgba(11,95,179,.18), transparent 55%),
        radial-gradient(900px 450px at 90% -20%, rgba(200,30,30,.14), transparent 55%),
        var(--bg);
    }

    /* 顶栏 */
    .topbar{
      position: sticky; top:0; z-index:50;
      background: linear-gradient(90deg, rgba(11,95,179,.96), rgba(10,79,149,.96));
      color:#fff;
      box-shadow: 0 6px 20px rgba(2, 32, 71, .18);
      border-bottom: 1px solid rgba(255,255,255,.12);
    }
    .topbar-inner{
      max-width: 1480px;
      margin: 0 auto;
      padding: 16px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
      min-width: 260px;
    }
    .emblem{
      width:40px; height:40px;
      border-radius: 12px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.18) 55%, transparent 56%),
        linear-gradient(145deg, rgba(255,255,255,.28), rgba(255,255,255,.08));
      border: 1px solid rgba(255,255,255,.22);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.08);
      position: relative;
    }
    .emblem:after{
      content:"";
      position:absolute; inset:10px 12px;
      border-radius:10px;
      background: linear-gradient(145deg, rgba(255,255,255,.9), rgba(255,255,255,.25));
      clip-path: polygon(10% 55%, 35% 35%, 48% 48%, 70% 22%, 92% 40%, 55% 88%, 30% 74%);
      opacity:.75;
    }
    .brand-title{
      line-height:1.05;
    }
    .brand-title .t1{
      font-size: 18px; font-weight: 800; letter-spacing:.5px;
    }
    .brand-title .t2{
      font-size: 12px; opacity:.9; margin-top:4px;
      letter-spacing:.2px;
    }
    .top-actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.14);
      border: 1px solid rgba(255,255,255,.16);
      font-size: 12px;
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:99px; background:#fff; opacity:.9;}
    .btn{
      border:0;
      cursor:pointer;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      font-size: 14px;
      transition: .15s ease;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn-primary{ background: linear-gradient(180deg, #ffffff, #eaf2ff); color: var(--blue2); border:1px solid rgba(255,255,255,.35);}
    .btn-primary:hover{filter: brightness(.98)}
    .btn-ghost{ background: rgba(255,255,255,.10); color:#fff; border:1px solid rgba(255,255,255,.18);}
    .btn-ghost:hover{background: rgba(255,255,255,.14);}
    .btn-danger{ background: linear-gradient(180deg, #ffecec, #ffd7d7); color: #8a0f0f; border: 1px solid rgba(200,30,30,.25);}
    .btn-danger:hover{filter: brightness(.98)}
    .btn-muted{ background: #f1f5f9; color:#0f172a; border:1px solid var(--line);}
    .btn-muted:hover{filter: brightness(.98)}

    /* 主体布局 */
    .wrap{
      max-width: 1480px;
      margin: 18px auto 50px;
      padding: 0 18px;
    }
    .grid{
      display:grid;
      grid-template-columns: 520px 1fr;
      gap: 18px;
      align-items: start;
    }
    .card{
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-hd{
      padding: 16px 18px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid var(--line);
      background:
        linear-gradient(180deg, rgba(11,95,179,.06), transparent);
    }
    .card-hd h2{
      margin:0;
      font-size: 16px;
      font-weight: 900;
      letter-spacing:.2px;
      display:flex; align-items:center; gap:10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: #fbfdff;
      white-space: nowrap;
    }
    .card-bd{ padding: 18px; }

    /* 表单 */
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px 14px;
    }
    .field{ display:flex; flex-direction:column; gap:8px; }
    .field.full{ grid-column: 1 / -1; }
    label{
      font-size: 13px;
      font-weight: 800;
      color:#0b2440;
      display:flex; align-items:center; gap:8px;
    }
    .req{ color: var(--red); font-weight: 900;}
    input, select, textarea{
      width:100%;
      border: 1px solid var(--line);
      background: #f9fbff;
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 14px;
      outline: none;
      transition: .15s ease;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(11,95,179,.35);
      box-shadow: 0 0 0 4px rgba(11,95,179,.12);
      background:#fff;
    }
    .actions-row{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top: 12px;
    }
    .legend{
      margin-top: 14px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px dashed rgba(11,95,179,.35);
      background: linear-gradient(180deg, rgba(11,95,179,.06), rgba(11,95,179,.02));
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
    }
    .legend-left{
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
      color: var(--muted); font-size: 12px; font-weight: 700;
    }
    .legitem{display:flex; align-items:center; gap:8px;}
    .legdot{width:10px; height:10px; border-radius:999px;}
    .legdot.green{background: var(--green);}
    .legdot.orange{background: var(--orange);}
    .legdot.red{background: var(--red);}
    .legend-right{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: var(--muted);
    }
    .kpi{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      font-weight: 900;
      color:#0b2440;
      white-space: nowrap;
    }

    /* 列表筛选 */
    .filters{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:end;
    }
    .filters .field{ min-width: 160px; flex: 1; }
    .filters .field.small{ min-width: 140px; flex: 0.8; }
    .filters .actions-row{ margin:0; }

    /* 表格（桌面） */
    table{
      width:100%;
      border-collapse: collapse;
      table-layout: fixed;   /* 关键：避免横向滚动 */
    }
    th, td{
      padding: 12px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
      font-size: 14px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    th{
      background: #f7fbff;
      color:#0b2440;
      font-weight: 900;
      font-size: 13px;
      position: sticky;
      top: 0;
      z-index: 5;
      border-bottom: 1px solid rgba(11,95,179,.18);
    }
    td .sub{
      display:block;
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      white-space: normal;
    }
    .nowrap{ white-space: nowrap; }
    .wraptext{ white-space: normal; word-break: break-word; }
    .type-chip{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fbfdff;
      font-weight: 900;
      font-size: 12px;
      color:#0b2440;
      white-space: nowrap;
    }
    .status{
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 900;
      white-space: nowrap;
    }
    .status .s-dot{ width:10px; height:10px; border-radius:999px; }
    .status.normal .s-dot{ background: var(--green); }
    .status.warning .s-dot{ background: var(--orange); }
    .status.overdue .s-dot{ background: var(--red); }

    .ops{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .btn-sm{
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 900;
    }
    .btn-blue{ background: #eaf2ff; color: var(--blue2); border:1px solid rgba(11,95,179,.22); }
    .btn-blue:hover{filter: brightness(.98)}
    .btn-green{ background: #e9fbf0; color: #0d5f2c; border:1px solid rgba(21,128,61,.22); }
    .btn-green:hover{filter: brightness(.98)}
    .btn-red{ background: #ffecec; color: #8a0f0f; border:1px solid rgba(200,30,30,.22); }
    .btn-red:hover{filter: brightness(.98)}

    /* 移动端：表格转卡片，彻底消灭横向滑动 */
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }
    @media (max-width: 820px){
      .form{ grid-template-columns: 1fr; }
      .filters{ flex-direction: column; align-items: stretch; }
      .filters .field{ min-width: unset; }
      .filters .actions-row{ width:100%; }
      .filters .actions-row .btn{ flex:1; }

      table, thead, tbody, th, td, tr { display:block; }
      thead{ display:none; }
      tr{
        border: 1px solid var(--line);
        border-radius: 16px;
        overflow:hidden;
        margin-bottom: 12px;
        box-shadow: 0 8px 24px rgba(2,32,71,.06);
      }
      td{
        border: 0;
        border-bottom: 1px solid var(--line);
        padding: 12px 12px;
        display:flex;
        gap: 10px;
      }
      td:last-child{ border-bottom: 0; }
      td::before{
        content: attr(data-label);
        flex: 0 0 92px;
        color:#0b2440;
        font-weight: 900;
        font-size: 12px;
      }
      .ops{ width:100%; }
      .ops .btn-sm{ flex:1; }
    }

    /* 弹窗（更新进度/详情） */
    .modal{
      display:none;
      position: fixed;
      inset:0;
      background: rgba(2, 12, 28, .55);
      z-index: 2000;
      padding: 18px;
      overflow:auto;
    }
    .modal .panel{
      max-width: 860px;
      margin: 40px auto;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(2,32,71,.22);
      overflow:hidden;
    }
    .modal .panel-hd{
      padding: 14px 16px;
      background: linear-gradient(180deg, rgba(11,95,179,.08), transparent);
      border-bottom: 1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modal .panel-hd h3{
      margin:0;
      font-size: 15px;
      font-weight: 900;
      color:#0b2440;
    }
    .x{
      cursor:pointer;
      width: 36px; height: 36px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background:#fff;
      font-size: 18px;
      display:flex; align-items:center; justify-content:center;
      color:#0f172a;
    }
    .x:hover{ filter: brightness(.98); }
    .modal .panel-bd{ padding: 16px; }
    .hint{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,95,179,.20);
      background: rgba(11,95,179,.06);
      color:#0b2440;
      font-size: 13px;
      line-height: 1.55;
      font-weight: 700;
    }
    .hint.warn{
      border-color: rgba(200,30,30,.22);
      background: rgba(200,30,30,.06);
    }
    .confirm-row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 14px;
    }
    .checkline{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background:#fbfdff;
      font-weight: 900;
      color:#0b2440;
    }
    .checkline input{ width:18px; height:18px; margin:0; }

    /* 详情页 tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px 12px;
      border-bottom: 1px solid var(--line);
      background:#fbfdff;
    }
    .tab{
      border:1px solid var(--line);
      background:#fff;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 13px;
      cursor:pointer;
    }
    .tab.active{
      border-color: rgba(11,95,179,.25);
      background: rgba(11,95,179,.08);
      color: var(--blue2);
    }
    .tabpane{ display:none; padding: 14px 16px; }
    .tabpane.active{ display:block; }
    .kv{
      display:grid;
      grid-template-columns: 140px 1fr;
      gap: 10px 12px;
      align-items:start;
    }
    .kv .k{ color: var(--muted); font-weight: 900; font-size: 13px; }
    .kv .v{ font-weight: 800; color:#0b2440; }
    .divider{ height:1px; background: var(--line); margin: 12px 0; }

    .doclist{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 10px;
    }
    .docitem{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border:1px solid var(--line);
      border-radius: 14px;
      background:#fbfdff;
      font-weight: 900;
      color:#0b2440;
    }
    .docitem input{ width:18px; height:18px; margin:0; }
    @media (max-width: 720px){
      .kv{ grid-template-columns: 1fr; }
      .doclist{ grid-template-columns: 1fr; }
    }

  </style>

  <!-- Excel库延迟加载：只在导入/导出时加载 -->
</head>

<body>
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="emblem" aria-hidden="true"></div>
        <div class="brand-title">
          <div class="t1">托里县应急管理局</div>
          <div class="t2">行政处罚案件管理</div>
        </div>
      </div>
      <div class="top-actions">
        <span class="pill" id="caseCountPill"><span class="dot"></span><span id="caseCountText">0 件</span></span>
        <button class="btn btn-ghost" id="btnBackup">备份</button>
        <button class="btn btn-primary" id="btnRestore">恢复</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- 新增案件 -->
      <div class="card">
        <div class="card-hd">
          <h2>新增案件</h2>
          <span class="badge">本地保存</span>
        </div>
        <div class="card-bd">
          <form id="caseForm" class="form">
            <div class="field">
              <label>案件编号 <span class="req">*</span></label>
              <input id="caseNumber" type="text" required placeholder="如：托应急罚〔2025〕001号" />
            </div>
            <div class="field">
              <label>立案日期 <span class="req">*</span></label>
              <input id="registerDate" type="date" required />
            </div>

            <div class="field">
              <label>企业名称 <span class="req">*</span></label>
              <input id="enterpriseName" type="text" required placeholder="填写涉事企业全称" />
            </div>
            <div class="field">
              <label>企业类型 <span class="req">*</span></label>
              <select id="enterpriseType" required>
                <option value="">请选择</option>
                <option value="矿山">矿山</option>
                <option value="危化">危化</option>
                <option value="工贸">工贸</option>
                <option value="烟花爆竹">烟花爆竹</option>
              </select>
            </div>

            <div class="field full">
              <label>案件名称 <span class="req">*</span></label>
              <input id="caseName" type="text" required placeholder="如：XX企业违规动火作业案" />
            </div>

            <div class="field full">
              <label>办案人 <span class="req">*</span></label>
              <input id="handlerName" type="text" required placeholder="多人用“/”分隔" />
            </div>

            <div class="actions-row full">
              <button type="submit" class="btn btn-primary">添加案件</button>
              <button type="button" class="btn btn-muted" id="btnTemplate">下载Excel模板</button>
              <button type="button" class="btn btn-muted" id="btnImport">导入Excel</button>
              <button type="button" class="btn btn-muted" id="btnExport">导出Excel</button>
            </div>

            <div class="legend full">
              <div class="legend-left">
                <span class="legitem"><span class="legdot green"></span>正常（>3天）</span>
                <span class="legitem"><span class="legdot orange"></span>临期（1–3天）</span>
                <span class="legitem"><span class="legdot red"></span>逾期（≤0天）</span>
              </div>
              <div class="legend-right">
                <span class="kpi" id="kpiDecisionMax">决定最晚日：—</span>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- 案件列表 -->
      <div class="card">
        <div class="card-hd">
          <h2>案件列表</h2>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span class="badge" id="badgeFiltered">全部</span>
            <button class="btn btn-primary" id="btnRefresh">刷新</button>
          </div>
        </div>

        <div class="card-bd">

          <div class="filters">
            <div class="field">
              <label>搜索</label>
              <input id="searchInput" type="text" placeholder="案件编号/企业名称/案件名称" />
            </div>
            <div class="field small">
              <label>进度</label>
              <select id="progressFilter">
                <option value="">全部</option>
              </select>
            </div>
            <div class="field small">
              <label>企业类型</label>
              <select id="typeFilter">
                <option value="">全部</option>
                <option value="矿山">矿山</option>
                <option value="危化">危化</option>
                <option value="工贸">工贸</option>
                <option value="烟花爆竹">烟花爆竹</option>
              </select>
            </div>
            <div class="field small">
              <label>状态</label>
              <select id="stateFilter">
                <option value="">全部</option>
                <option value="normal">正常</option>
                <option value="warning">临期</option>
                <option value="overdue">逾期</option>
              </select>
            </div>
            <div class="actions-row">
              <button class="btn btn-muted" type="button" id="btnFilter">筛选</button>
              <button class="btn btn-muted" type="button" id="btnReset">重置</button>
            </div>
          </div>

          <div class="divider"></div>

          <div style="overflow: visible;">
            <table>
              <thead>
                <tr>
                  <th style="width:140px;">案件编号</th>
                  <th style="width:160px;">企业名称</th>
                  <th style="width:90px;">类型</th>
                  <th style="width:200px;">案件名称</th>
                  <th style="width:140px;">办案人</th>
                  <th style="width:160px;">当前进度</th>
                  <th style="width:160px;">截止事项</th>
                  <th style="width:120px;">截止日期</th>
                  <th style="width:90px;">剩余</th>
                  <th style="width:190px;">操作</th>
                </tr>
              </thead>
              <tbody id="caseTbody"></tbody>
            </table>
          </div>

        </div>
      </div>

    </div>
  </div>

  <!-- 更新进度弹窗（只弹这个，不弹详情） -->
  <div class="modal" id="updateModal" aria-hidden="true">
    <div class="panel">
      <div class="panel-hd">
        <h3 id="updateTitle">更新进度</h3>
        <div class="x" id="closeUpdate">×</div>
      </div>
      <div class="panel-bd">
        <div class="hint" id="updateHint"></div>

        <div class="form" style="margin-top: 12px;">
          <div class="field">
            <label>完成日期 <span class="req">*</span></label>
            <input type="date" id="updateDate" />
          </div>
          <div class="field">
            <label>备注</label>
            <input type="text" id="updateRemark" placeholder="可不填" />
          </div>
          <div class="field full">
            <div class="checkline">
              <input type="checkbox" id="updateAck" />
              <span>已确认本阶段材料办理完成</span>
            </div>
          </div>
        </div>

        <div class="confirm-row">
          <button class="btn btn-muted" id="btnUpdateCancel" type="button">取消</button>
          <button class="btn btn-primary" id="btnUpdateConfirm" type="button">确认更新</button>
        </div>

        <div style="margin-top: 12px;">
          <div class="hint warn" id="updateWarn" style="display:none;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 详情弹窗（仅点击“详情”才弹） -->
  <div class="modal" id="detailModal" aria-hidden="true">
    <div class="panel">
      <div class="panel-hd">
        <h3 id="detailTitle">案件详情</h3>
        <div class="x" id="closeDetail">×</div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="tabBasic">基本信息</button>
        <button class="tab" data-tab="tabTimeline">进度记录</button>
        <button class="tab" data-tab="tabDocs">文书清单</button>
        <button class="tab" data-tab="tabFiles">文件上传</button>
      </div>

      <div class="tabpane active" id="tabBasic">
        <div class="kv" id="basicKv"></div>
      </div>

      <div class="tabpane" id="tabTimeline">
        <div id="timelineBox"></div>
      </div>

      <div class="tabpane" id="tabDocs">
        <div class="hint" style="margin-bottom:12px;">
          “案卷立卷”完成前，文书清单需勾选齐全；文件上传可选填。
        </div>
        <div class="doclist" id="docList"></div>
        <div class="confirm-row">
          <button class="btn btn-primary" id="btnSaveDocs" type="button">保存勾选</button>
        </div>
      </div>

      <div class="tabpane" id="tabFiles">
        <div class="hint" style="margin-bottom:12px;">
          文件上传为选填项，用于内部归集与查阅。
        </div>

        <div class="form">
          <div class="field full">
            <label>选择文件</label>
            <input type="file" id="fileInput" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
          </div>
          <div class="field full">
            <label>备注</label>
            <input type="text" id="fileRemark" placeholder="可不填" />
          </div>
          <div class="actions-row full">
            <button class="btn btn-primary" id="btnUploadFile" type="button">上传</button>
          </div>
        </div>

        <div class="divider"></div>
        <div id="fileList"></div>
      </div>

    </div>
  </div>

  <!-- 预览弹窗（图片/pdf） -->
  <div class="modal" id="previewModal" aria-hidden="true">
    <div class="panel" style="max-width: 980px;">
      <div class="panel-hd">
        <h3 id="previewTitle">预览</h3>
        <div class="x" id="closePreview">×</div>
      </div>
      <div class="panel-bd" style="height: 70vh;">
        <img id="previewImg" style="display:none; max-width:100%; max-height:100%; margin:0 auto;" />
        <embed id="previewPdf" style="display:none; width:100%; height:100%;" type="application/pdf" />
        <div id="previewUnsupported" class="hint warn" style="display:none;">暂不支持该格式预览。</div>
      </div>
    </div>
  </div>

  <script>
    /*************** 存储键 ***************/
    const STORE_KEY = "tlx_em_punish_cases_v2";

    /*************** 进度配置 ***************/
    const PROGRESS = [
      { id: 1, name: "立案" },
      { id: 2, name: "调查取证" },          // 立案后30日内（提示）
      { id: 3, name: "集体讨论完成" },      // 决定前
      { id: 4, name: "处罚事先告知" },      // 决定前≥3天
      { id: 5, name: "作出处罚决定" },      // 立案后≤90天（硬上限）
      { id: 6, name: "送达处罚决定书" },    // 决定后≤7天
      { id: 7, name: "罚款缴纳" },          // 送达后≤15天
      { id: 8, name: "案件结案" },          // 缴纳后（提示：尽快）
      { id: 9, name: "案卷立卷" },          // 决定后≤20个工作日（硬上限）
      { id: 10, name: "案卷归档" }          // 结案后≤30天
    ];
    const PROGRESS_MAP = Object.fromEntries(PROGRESS.map(x => [x.id, x.name]));

    /*************** 新疆节假日（2026 + 常用国家法定，可自行补充） ***************/
    const XJ_HOLIDAYS = new Set([
      // 2026（示例：按已有版本，实际可继续补齐）
      "2026-01-01","2026-01-02","2026-01-03",
      "2026-02-17","2026-02-18","2026-02-19","2026-02-20","2026-02-21","2026-02-22","2026-02-23",
      "2026-03-21",
      "2026-04-22","2026-04-23","2026-04-24",
      "2026-05-01","2026-05-02","2026-05-03","2026-05-04","2026-05-05",
      "2026-06-09","2026-06-10",
      "2026-07-31","2026-08-01","2026-08-02",
      "2026-09-17","2026-09-18",
      "2026-10-01","2026-10-02","2026-10-03","2026-10-04","2026-10-05","2026-10-06","2026-10-07"
    ]);

    /*************** 文书清单（立卷前需勾齐） ***************/
    const DOCS = [
      { key:"doc1",  name:"案卷封面（正卷）" },
      { key:"doc2",  name:"卷内目录" },
      { key:"doc3",  name:"行政处罚决定书" },
      { key:"doc4",  name:"立案审批表" },
      { key:"doc5",  name:"案件处理呈批表" },
      { key:"doc6",  name:"行政处罚集体讨论记录" },
      { key:"doc7",  name:"行政处罚事先告知书" },
      { key:"doc8",  name:"送达回执" },
      { key:"doc9",  name:"罚款收据/缴纳凭证" },
      { key:"doc10", name:"现场检查记录" },
      { key:"doc11", name:"询问通知书/询问笔录" },
      { key:"doc12", name:"责令限期整改指令书/整改复查意见书" },
      { key:"doc13", name:"证据材料" },
      { key:"doc14", name:"其他相关文书" },
      { key:"doc15", name:"结案审批表" }
    ];

    /*************** 工具函数 ***************/
    function pad(n){ return String(n).padStart(2,"0"); }
    function fmt(d){
      const dt = (d instanceof Date) ? d : new Date(d);
      return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
    }
    function parseDate(s){
      // 按本地零点解析，避免时区偏移
      return new Date(s + "T00:00:00");
    }
    function addDays(dateStr, days){
      const d = parseDate(dateStr);
      d.setDate(d.getDate()+days);
      return fmt(d);
    }
    function isWeekend(dateObj){
      const w = dateObj.getDay();
      return w===0 || w===6;
    }
    function addWorkDays(dateStr, workDays){
      let d = parseDate(dateStr);
      let c = 0;
      while(c < workDays){
        d.setDate(d.getDate()+1);
        const ds = fmt(d);
        if(!isWeekend(d) && !XJ_HOLIDAYS.has(ds)) c++;
      }
      return fmt(d);
    }
    function diffDays(toDateStr){
      if(!toDateStr) return null;
      const today = new Date();
      const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate()); // today 00:00
      const end = parseDate(toDateStr);
      const ms = end - t0;
      return Math.ceil(ms / 86400000);
    }
    function statusByRemain(remain){
      if(remain === null) return "normal";
      if(remain > 3) return "normal";
      if(remain >= 1) return "warning";
      return "overdue";
    }
    function remainText(remain){
      if(remain === null) return "—";
      if(remain > 0) return remain + "天";
      if(remain === 0) return "最后1天";
      return "逾期" + Math.abs(remain) + "天";
    }

    /*************** 核心：期限逻辑（不顺延90天硬上限） ***************/
    function getDecisionMaxDate(caseItem){
      return addDays(caseItem.registerDate, 90); // 默认硬上限90天（如需延长到180，可扩展字段）
    }
    function getNoticeLatestDate(caseItem){
      // 告知→决定 ≥3天，因此告知最晚日 = 决定最晚日 - 3天
      return addDays(getDecisionMaxDate(caseItem), -3);
    }
    function getInvestigationDueDate(caseItem){
      return addDays(caseItem.registerDate, 30);
    }

    function getDueInfo(caseItem){
      // 返回：{label, date, extraLines[]}
      const p = caseItem.progress;
      const extra = [];
      const decisionMax = getDecisionMaxDate(caseItem);

      // 决定前：永远展示决定硬上限（不随操作顺延）
      if(p <= 4){
        extra.push("决定最晚日：" + decisionMax);
      }

      if(p === 1){
        // 下一关键：调查取证最晚日（提示） + 决定硬上限
        return { label: "调查取证最晚日", date: getInvestigationDueDate(caseItem), extraLines: extra };
      }
      if(p === 2 || p === 3){
        // 决定前要留3天间隔：优先盯住“告知最晚日”
        return { label: "告知最晚日", date: getNoticeLatestDate(caseItem), extraLines: extra };
      }
      if(p === 4){
        // 告知完成后：最早可决定日 = 告知完成日+3；最晚=决定最晚日
        const noticeDone = caseItem.dates?.noticeDone;
        if(noticeDone){
          extra.unshift("最早可决定日：" + addDays(noticeDone, 3));
        }else{
          extra.unshift("最早可决定日：告知完成日+3");
        }
        return { label: "决定最晚日", date: decisionMax, extraLines: extra };
      }
      if(p === 5){
        const decisionDate = caseItem.dates?.decisionDate;
        const due = decisionDate ? addDays(decisionDate, 7) : null;
        return { label: "送达最晚日", date: due, extraLines: [] };
      }
      if(p === 6){
        const deliveryDate = caseItem.dates?.deliveryDate;
        const due = deliveryDate ? addDays(deliveryDate, 15) : null;
        return { label: "缴纳最晚日", date: due, extraLines: [] };
      }
      if(p === 7){
        const payDate = caseItem.dates?.paymentDate;
        return { label: "建议结案日", date: payDate || null, extraLines: [] };
      }
      if(p === 8){
        const decisionDate = caseItem.dates?.decisionDate;
        const filingDue = decisionDate ? addWorkDays(decisionDate, 20) : null;
        const closeDate = caseItem.dates?.closureDate;
        const archiveDue = closeDate ? addDays(closeDate, 30) : null;
        const ex = [];
        if(archiveDue) ex.push("归档最晚日：" + archiveDue);
        return { label: "立卷最晚日", date: filingDue, extraLines: ex };
      }
      if(p === 9){
        const closeDate = caseItem.dates?.closureDate;
        const archiveDue = closeDate ? addDays(closeDate, 30) : null;
        return { label: "归档最晚日", date: archiveDue, extraLines: [] };
      }
      return { label: "—", date: null, extraLines: [] };
    }

    function isDocsComplete(caseItem){
      const ck = caseItem.documentChecklist || {};
      return DOCS.every(d => ck[d.key] === true);
    }

    /*************** 存取 ***************/
    function loadCases(){
      const raw = localStorage.getItem(STORE_KEY);
      try{
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch{
        return [];
      }
    }
    function saveCases(arr){
      localStorage.setItem(STORE_KEY, JSON.stringify(arr));
      updateCaseCount(arr.length);
    }
    function updateCaseCount(n){
      document.getElementById("caseCountText").textContent = n + " 件";
    }

    /*************** 渲染：筛选下拉 ***************/
    function initProgressFilter(){
      const sel = document.getElementById("progressFilter");
      sel.innerHTML = `<option value="">全部</option>` + PROGRESS.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
    }

    /*************** 渲染：列表 ***************/
    function renderTable(list){
      const tbody = document.getElementById("caseTbody");
      tbody.innerHTML = "";

      if(list.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="10" style="padding:18px; text-align:center; color:#64748b; font-weight:800;">暂无案件</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach(item => {
        const due = getDueInfo(item);
        const remain = due.date ? diffDays(due.date) : null;
        const st = statusByRemain(remain);

        const tr = document.createElement("tr");

        const progressName = PROGRESS_MAP[item.progress] || "—";
        const typeChip = `<span class="type-chip">${item.enterpriseType || "—"}</span>`;

        const statusHtml = `
          <span class="status ${st}">
            <span class="s-dot"></span>
            <span>${st==="normal"?"正常":st==="warning"?"临期":"逾期"}</span>
          </span>
        `;

        const extraHtml = (due.extraLines && due.extraLines.length)
          ? `<span class="sub">${due.extraLines.map(x => escapeHtml(x)).join("<br/>")}</span>`
          : "";

        tr.innerHTML = `
          <td class="wraptext" data-label="案件编号">${escapeHtml(item.caseNumber || "")}</td>
          <td class="wraptext" data-label="企业名称">${escapeHtml(item.enterpriseName || "")}</td>
          <td data-label="类型">${typeChip}</td>
          <td class="wraptext" data-label="案件名称">${escapeHtml(item.caseName || "")}</td>
          <td class="wraptext" data-label="办案人">${escapeHtml(item.handlerName || "")}</td>
          <td class="wraptext" data-label="当前进度">${escapeHtml(progressName)}<span class="sub">${statusHtml}</span></td>
          <td class="wraptext" data-label="截止事项">${escapeHtml(due.label || "—")}${extraHtml}</td>
          <td class="nowrap" data-label="截止日期">${due.date ? due.date : "—"}</td>
          <td class="nowrap" data-label="剩余"><strong>${remainText(remain)}</strong></td>
          <td data-label="操作">
            <div class="ops">
              <button class="btn btn-sm btn-blue" data-act="detail" data-id="${item.id}">详情</button>
              ${item.progress < 10 ? `<button class="btn btn-sm btn-green" data-act="update" data-id="${item.id}">更新</button>` : ""}
              <button class="btn btn-sm btn-red" data-act="delete" data-id="${item.id}">删除</button>
            </div>
          </td>
        `;

        tbody.appendChild(tr);
      });
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /*************** 筛选 ***************/
    function applyFilter(){
      const q = (document.getElementById("searchInput").value || "").trim().toLowerCase();
      const p = document.getElementById("progressFilter").value;
      const t = document.getElementById("typeFilter").value;
      const s = document.getElementById("stateFilter").value;

      let arr = loadCases();

      if(q){
        arr = arr.filter(x =>
          (x.caseNumber||"").toLowerCase().includes(q) ||
          (x.enterpriseName||"").toLowerCase().includes(q) ||
          (x.caseName||"").toLowerCase().includes(q)
        );
      }
      if(p){
        arr = arr.filter(x => String(x.progress) === String(p));
      }
      if(t){
        arr = arr.filter(x => x.enterpriseType === t);
      }
      if(s){
        arr = arr.filter(x => {
          const due = getDueInfo(x);
          const remain = due.date ? diffDays(due.date) : null;
          const st = statusByRemain(remain);
          return st === s;
        });
      }

      document.getElementById("badgeFiltered").textContent = arr.length === loadCases().length ? "全部" : `筛选：${arr.length}件`;
      renderTable(arr);

      // 左侧KPI：如果表单立案日期填了，就展示该日期的决定最晚日
      const rd = document.getElementById("registerDate").value;
      document.getElementById("kpiDecisionMax").textContent = rd ? ("决定最晚日：" + addDays(rd, 90)) : "决定最晚日：—";
    }

    function resetFilter(){
      document.getElementById("searchInput").value = "";
      document.getElementById("progressFilter").value = "";
      document.getElementById("typeFilter").value = "";
      document.getElementById("stateFilter").value = "";
      document.getElementById("badgeFiltered").textContent = "全部";
      renderTable(loadCases());
    }

    /*************** 添加案件 ***************/
    document.getElementById("caseForm").addEventListener("submit", (e) => {
      e.preventDefault();

      const caseNumber = document.getElementById("caseNumber").value.trim();
      const enterpriseName = document.getElementById("enterpriseName").value.trim();
      const enterpriseType = document.getElementById("enterpriseType").value;
      const caseName = document.getElementById("caseName").value.trim();
      const handlerName = document.getElementById("handlerName").value.trim();
      const registerDate = document.getElementById("registerDate").value;

      if(!caseNumber || !enterpriseName || !enterpriseType || !caseName || !handlerName || !registerDate){
        return;
      }

      const arr = loadCases();

      const id = String(Date.now()) + "_" + Math.random().toString(36).slice(2,8);
      const nowIso = new Date().toISOString();

      const item = {
        id,
        caseNumber, enterpriseName, enterpriseType, caseName, handlerName,
        registerDate,
        progress: 1,
        dates: { registerDate },
        progressLogs: [
          { progressId: 1, progressName: PROGRESS_MAP[1], date: registerDate, ts: nowIso, remark: "" }
        ],
        documentChecklist: {},
        uploadedFiles: [] // {name,type,size,data,remark,ts}
      };

      arr.unshift(item);
      saveCases(arr);
      e.target.reset();
      document.getElementById("kpiDecisionMax").textContent = "决定最晚日：—";
      renderTable(arr);
    });

    /*************** 表格按钮事件代理 ***************/
    document.getElementById("caseTbody").addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;
      const act = btn.dataset.act;
      const id = btn.dataset.id;
      if(!act || !id) return;

      if(act === "detail"){
        openDetail(id);
        return;
      }
      if(act === "update"){
        openUpdate(id);
        return;
      }
      if(act === "delete"){
        deleteCase(id);
        return;
      }
    });

    /*************** 删除 ***************/
    function deleteCase(id){
      const arr = loadCases();
      const item = arr.find(x => x.id === id);
      if(!item) return;
      const ok = confirm("确定删除该案件？删除后无法恢复。");
      if(!ok) return;
      const next = arr.filter(x => x.id !== id);
      saveCases(next);
      renderTable(next);
    }

    /*************** 更新进度：只弹更新弹窗（不弹详情） ***************/
    let UPDATE_ID = "";
    function openUpdate(id){
      const arr = loadCases();
      const item = arr.find(x => x.id === id);
      if(!item) return;

      UPDATE_ID = id;
      document.getElementById("updateAck").checked = false;
      document.getElementById("updateRemark").value = "";
      document.getElementById("updateWarn").style.display = "none";
      document.getElementById("updateDate").value = fmt(new Date());

      const cur = item.progress;
      const next = Math.min(cur + 1, 10);
      const curName = PROGRESS_MAP[cur];
      const nextName = PROGRESS_MAP[next];

      document.getElementById("updateTitle").textContent = `更新进度：${curName} → ${nextName}`;

      // 提示：展示关键校验（尤其决定90天硬上限）
      const hint = buildUpdateHint(item, cur, next);
      document.getElementById("updateHint").innerHTML = hint;

      showModal("updateModal");
    }

    function buildUpdateHint(item, cur, next){
      const decisionMax = getDecisionMaxDate(item);
      const dueInfo = getDueInfo(item);
      const remain = dueInfo.date ? diffDays(dueInfo.date) : null;

      let lines = [];
      lines.push(`<b>当前进度：</b>${escapeHtml(PROGRESS_MAP[cur])}`);
      lines.push(`<b>下一进度：</b>${escapeHtml(PROGRESS_MAP[next])}`);

      // 决定前强调硬上限
      if(cur <= 4){
        lines.push(`<b>决定最晚日：</b>${decisionMax}（不随操作顺延）`);
      }

      if(dueInfo.date){
        lines.push(`<b>当前截止事项：</b>${escapeHtml(dueInfo.label)}（${dueInfo.date}，${remainText(remain)}）`);
      }

      // 特殊校验说明
      if(next === 5){
        // 进入“作出处罚决定”
        if(item.dates?.noticeDone){
          lines.push(`<b>告知完成日：</b>${item.dates.noticeDone}（决定日期需≥告知完成日+3）`);
        }else{
          lines.push(`<b>告知完成日：</b>未记录（建议先在“处罚事先告知”阶段填写完成日期）`);
        }
      }
      if(next === 9){
        lines.push(`<b>立卷要求：</b>文书清单需勾选齐全`);
      }

      return lines.join("<br/>");
    }

    function closeUpdate(){
      UPDATE_ID = "";
      hideModal("updateModal");
    }
    document.getElementById("closeUpdate").addEventListener("click", closeUpdate);
    document.getElementById("btnUpdateCancel").addEventListener("click", closeUpdate);

    document.getElementById("btnUpdateConfirm").addEventListener("click", () => {
      const id = UPDATE_ID;
      const arr = loadCases();
      const idx = arr.findIndex(x => x.id === id);
      if(idx < 0) return;

      const item = arr[idx];
      const cur = item.progress;
      const next = Math.min(cur + 1, 10);

      const doneDate = document.getElementById("updateDate").value;
      const remark = document.getElementById("updateRemark").value.trim();
      const ack = document.getElementById("updateAck").checked;

      if(!doneDate){
        showUpdateWarn("完成日期不能为空。");
        return;
      }
      if(!ack){
        showUpdateWarn("需勾选“已确认本阶段材料办理完成”。");
        return;
      }

      // 校验逻辑（关键：决定90天硬上限不顺延）
      const msg = validateProgressUpdate(item, cur, next, doneDate);
      if(msg){
        showUpdateWarn(msg);
        return;
      }

      // 写入完成日期
      if(!item.dates) item.dates = { registerDate: item.registerDate };

      // 按阶段记录日期
      if(next === 2) item.dates.investigationDone = doneDate;
      if(next === 3) item.dates.discussionDone = doneDate;
      if(next === 4) item.dates.noticeDone = doneDate;
      if(next === 5) item.dates.decisionDate = doneDate;
      if(next === 6) item.dates.deliveryDate = doneDate;
      if(next === 7) item.dates.paymentDate = doneDate;
      if(next === 8) item.dates.closureDate = doneDate;
      if(next === 9) item.dates.filingDate = doneDate;
      if(next === 10) item.dates.archiveDate = doneDate;

      // 更新进度
      item.progress = next;
      item.updateTime = new Date().toISOString();

      // 记录日志
      if(!Array.isArray(item.progressLogs)) item.progressLogs = [];
      item.progressLogs.push({
        progressId: next,
        progressName: PROGRESS_MAP[next],
        date: doneDate,
        ts: new Date().toISOString(),
        remark
      });

      arr[idx] = item;
      saveCases(arr);
      renderTable(arr);
      closeUpdate();
    });

    function showUpdateWarn(text){
      const el = document.getElementById("updateWarn");
      el.textContent = text;
      el.style.display = "block";
    }

    function validateProgressUpdate(item, cur, next, doneDate){
      const decisionMax = getDecisionMaxDate(item);

      // 决定前：决定日期不得超过硬上限
      if(next === 5){
        if(doneDate > decisionMax){
          return `决定日期不得晚于决定最晚日（${decisionMax}）。`;
        }
        // 告知→决定 ≥3天（若有告知完成日）
        const noticeDone = item.dates?.noticeDone;
        if(noticeDone){
          const earliest = addDays(noticeDone, 3);
          if(doneDate < earliest){
            return `决定日期不得早于最早可决定日（${earliest}）。`;
          }
        }
      }

      // 送达：决定后≤7天
      if(next === 6){
        const decisionDate = item.dates?.decisionDate;
        if(!decisionDate) return "缺少决定日期，需先完成“作出处罚决定”。";
        const due = addDays(decisionDate, 7);
        if(doneDate > due) return `送达日期不得晚于送达最晚日（${due}）。`;
        if(doneDate < decisionDate) return "送达日期不得早于决定日期。";
      }

      // 缴纳：送达后≤15天
      if(next === 7){
        const deliveryDate = item.dates?.deliveryDate;
        if(!deliveryDate) return "缺少送达日期，需先完成“送达处罚决定书”。";
        const due = addDays(deliveryDate, 15);
        if(doneDate > due) return `缴纳日期不得晚于缴纳最晚日（${due}）。`;
        if(doneDate < deliveryDate) return "缴纳日期不得早于送达日期。";
      }

      // 结案：不早于缴纳
      if(next === 8){
        const payDate = item.dates?.paymentDate;
        if(!payDate) return "缺少缴纳日期，需先完成“罚款缴纳”。";
        if(doneDate < payDate) return "结案日期不得早于缴纳日期。";
      }

      // 立卷：决定后≤20个工作日 + 文书清单勾齐
      if(next === 9){
        const decisionDate = item.dates?.decisionDate;
        if(!decisionDate) return "缺少决定日期，无法计算立卷期限。";
        const due = addWorkDays(decisionDate, 20);
        if(doneDate > due) return `立卷日期不得晚于立卷最晚日（${due}）。`;
        if(!isDocsComplete(item)) return "文书清单未勾选齐全，需在“详情 → 文书清单”完成勾选后再立卷。";
      }

      // 归档：结案后≤30天
      if(next === 10){
        const closeDate = item.dates?.closureDate;
        if(!closeDate) return "缺少结案日期，需先完成“案件结案”。";
        const due = addDays(closeDate, 30);
        if(doneDate > due) return `归档日期不得晚于归档最晚日（${due}）。`;
        if(doneDate < closeDate) return "归档日期不得早于结案日期。";
      }

      // 决定前其它阶段：不做强制日期校验，但仍建议不晚于对应提示节点
      // 同时：决定前的任何操作不影响决定硬上限，本函数已保证不顺延。

      return "";
    }

    /*************** 详情弹窗 ***************/
    let DETAIL_ID = "";
    function openDetail(id){
      const arr = loadCases();
      const item = arr.find(x => x.id === id);
      if(!item) return;

      DETAIL_ID = id;
      document.getElementById("detailTitle").textContent = "案件详情：" + (item.caseNumber || "");

      // 基本信息
      const due = getDueInfo(item);
      const remain = due.date ? diffDays(due.date) : null;
      const kv = [
        ["案件编号", item.caseNumber],
        ["企业名称", item.enterpriseName],
        ["企业类型", item.enterpriseType],
        ["案件名称", item.caseName],
        ["办案人", item.handlerName],
        ["立案日期", item.registerDate],
        ["当前进度", PROGRESS_MAP[item.progress] || "—"],
        ["截止事项", due.label || "—"],
        ["截止日期", due.date || "—"],
        ["剩余", remainText(remain)],
        ["决定最晚日", getDecisionMaxDate(item)],
        ["告知最晚日", getNoticeLatestDate(item)]
      ];
      const basicKv = document.getElementById("basicKv");
      basicKv.innerHTML = kv.map(([k,v]) => `<div class="k">${escapeHtml(k)}</div><div class="v">${escapeHtml(v ?? "—")}</div>`).join("");

      // 进度记录
      const logs = Array.isArray(item.progressLogs) ? [...item.progressLogs] : [];
      logs.sort((a,b)=> new Date(a.ts)-new Date(b.ts));
      const timeline = document.getElementById("timelineBox");
      if(!logs.length){
        timeline.innerHTML = `<div class="hint">暂无记录</div>`;
      }else{
        timeline.innerHTML = logs.map(l => `
          <div style="padding:12px 12px; border:1px solid var(--line); border-radius:14px; background:#fbfdff; margin-bottom:10px;">
            <div style="font-weight:900; color:#0b2440;">${escapeHtml(l.progressName || "")}</div>
            <div style="margin-top:6px; color:var(--muted); font-weight:800; font-size:12px;">
              完成日期：${escapeHtml(l.date || "—")}　｜　记录时间：${escapeHtml(new Date(l.ts).toLocaleString())}
            </div>
            ${l.remark ? `<div style="margin-top:6px; color:#0f172a; font-weight:800; font-size:13px;">备注：${escapeHtml(l.remark)}</div>` : ""}
          </div>
        `).join("");
      }

      // 文书清单
      const docList = document.getElementById("docList");
      const ck = item.documentChecklist || {};
      docList.innerHTML = DOCS.map(d => `
        <label class="docitem">
          <input type="checkbox" data-doc="${d.key}" ${ck[d.key] ? "checked" : ""} />
          <span>${escapeHtml(d.name)}</span>
        </label>
      `).join("");

      // 文件列表
      renderFiles(item);

      // 默认tab回到基本信息
      setActiveTab("tabBasic");

      showModal("detailModal");
    }

    function closeDetail(){
      DETAIL_ID = "";
      hideModal("detailModal");
    }
    document.getElementById("closeDetail").addEventListener("click", closeDetail);

    // tabs
    document.querySelectorAll("#detailModal .tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        setActiveTab(btn.dataset.tab);
      });
    });
    function setActiveTab(id){
      document.querySelectorAll("#detailModal .tab").forEach(t => t.classList.toggle("active", t.dataset.tab === id));
      document.querySelectorAll("#detailModal .tabpane").forEach(p => p.classList.toggle("active", p.id === id));
    }

    // 保存文书勾选
    document.getElementById("btnSaveDocs").addEventListener("click", () => {
      if(!DETAIL_ID) return;
      const arr = loadCases();
      const idx = arr.findIndex(x => x.id === DETAIL_ID);
      if(idx < 0) return;

      const item = arr[idx];
      if(!item.documentChecklist) item.documentChecklist = {};

      document.querySelectorAll("#docList input[type='checkbox']").forEach(ch=>{
        const key = ch.dataset.doc;
        item.documentChecklist[key] = ch.checked;
      });

      arr[idx] = item;
      saveCases(arr);
      renderTable(arr);
      alert("已保存。");
    });

    /*************** 文件上传（选填） ***************/
    document.getElementById("btnUploadFile").addEventListener("click", () => {
      if(!DETAIL_ID) return;
      const fileEl = document.getElementById("fileInput");
      const file = fileEl.files[0];
      if(!file){
        alert("请选择文件。");
        return;
      }
      const remark = document.getElementById("fileRemark").value.trim();

      const reader = new FileReader();
      reader.onload = (ev) => {
        const arr = loadCases();
        const idx = arr.findIndex(x => x.id === DETAIL_ID);
        if(idx < 0) return;
        const item = arr[idx];

        if(!Array.isArray(item.uploadedFiles)) item.uploadedFiles = [];
        item.uploadedFiles.unshift({
          name: file.name,
          type: file.type,
          size: file.size,
          data: ev.target.result,
          remark,
          ts: new Date().toISOString()
        });

        arr[idx] = item;
        saveCases(arr);
        renderFiles(item);

        fileEl.value = "";
        document.getElementById("fileRemark").value = "";
        alert("上传成功。");
      };
      reader.readAsDataURL(file);
    });

    function renderFiles(item){
      const box = document.getElementById("fileList");
      const files = Array.isArray(item.uploadedFiles) ? item.uploadedFiles : [];
      if(!files.length){
        box.innerHTML = `<div class="hint">暂无文件</div>`;
        return;
      }
      box.innerHTML = files.map((f, i) => `
        <div style="padding:12px 12px; border:1px solid var(--line); border-radius:14px; background:#fbfdff; margin-bottom:10px;">
          <div style="font-weight:900; color:#0b2440;">${escapeHtml(f.name)}</div>
          <div style="margin-top:6px; color:var(--muted); font-weight:800; font-size:12px;">
            上传时间：${escapeHtml(new Date(f.ts).toLocaleString())}
            ｜大小：${(f.size/1024).toFixed(1)}KB
          </div>
          ${f.remark ? `<div style="margin-top:6px; font-weight:800; font-size:13px;">备注：${escapeHtml(f.remark)}</div>` : ""}
          <div class="confirm-row" style="margin-top:10px;">
            <button class="btn btn-muted btn-sm" type="button" data-fact="preview" data-fi="${i}">预览</button>
            <button class="btn btn-danger btn-sm" type="button" data-fact="remove" data-fi="${i}">删除</button>
          </div>
        </div>
      `).join("");

      // 绑定按钮
      box.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=>{
          const act = b.dataset.fact;
          const fi = Number(b.dataset.fi);
          if(Number.isNaN(fi)) return;

          if(act === "preview") previewFile(item, fi);
          if(act === "remove") removeFile(fi);
        });
      });
    }

    function removeFile(index){
      if(!DETAIL_ID) return;
      const ok = confirm("确定删除该文件？");
      if(!ok) return;

      const arr = loadCases();
      const idx = arr.findIndex(x => x.id === DETAIL_ID);
      if(idx < 0) return;
      const item = arr[idx];

      item.uploadedFiles = (item.uploadedFiles || []).filter((_,i)=> i!==index);
      arr[idx] = item;
      saveCases(arr);
      renderFiles(item);
    }

    function previewFile(item, index){
      const files = item.uploadedFiles || [];
      const f = files[index];
      if(!f) return;

      document.getElementById("previewTitle").textContent = "预览：" + f.name;

      const img = document.getElementById("previewImg");
      const pdf = document.getElementById("previewPdf");
      const uns = document.getElementById("previewUnsupported");
      img.style.display = "none";
      pdf.style.display = "none";
      uns.style.display = "none";

      if((f.type || "").includes("image")){
        img.src = f.data;
        img.style.display = "block";
      }else if((f.type || "").includes("pdf")){
        pdf.src = f.data;
        pdf.style.display = "block";
      }else{
        uns.style.display = "block";
      }
      showModal("previewModal");
    }
    document.getElementById("closePreview").addEventListener("click", ()=>hideModal("previewModal"));

    /*************** 备份/恢复 ***************/
    document.getElementById("btnBackup").addEventListener("click", () => {
      const data = loadCases();
      const blob = new Blob([JSON.stringify({ version: 2, ts: new Date().toISOString(), data }, null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `托里县应急_案件备份_${fmt(new Date())}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById("btnRestore").addEventListener("click", () => {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".json";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try{
            const obj = JSON.parse(ev.target.result);
            const data = obj.data || obj;
            if(!Array.isArray(data)){
              alert("恢复失败：文件格式不正确。");
              return;
            }
            saveCases(data);
            renderTable(data);
            alert("恢复完成。");
          }catch{
            alert("恢复失败：无法解析文件。");
          }
        };
        reader.readAsText(file, "utf-8");
      };
      input.click();
    });

    /*************** Excel：延迟加载 ***************/
    function ensureXLSX(){
      return new Promise((resolve, reject) => {
        if(window.XLSX) return resolve();
        const s = document.createElement("script");
        s.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("XLSX加载失败"));
        document.head.appendChild(s);
      });
    }

    document.getElementById("btnTemplate").addEventListener("click", async () => {
      try{
        await ensureXLSX();
        const template = [{
          "案件编号":"",
          "企业名称":"",
          "企业类型":"矿山/危化/工贸/烟花爆竹",
          "案件名称":"",
          "办案人":"",
          "立案日期":"YYYY-MM-DD"
        }];
        const ws = XLSX.utils.json_to_sheet(template);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "模板");
        XLSX.writeFile(wb, "案件录入模板.xlsx");
      }catch{
        alert("模板生成失败。");
      }
    });

    document.getElementById("btnImport").addEventListener("click", async () => {
      try{
        await ensureXLSX();
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".xlsx,.xls";
        input.onchange = (e) => {
          const file = e.target.files[0];
          if(!file) return;
          const reader = new FileReader();
          reader.onload = (ev) => {
            try{
              const data = new Uint8Array(ev.target.result);
              const wb = XLSX.read(data, { type: "array" });
              const ws = wb.Sheets[wb.SheetNames[0]];
              const rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

              const arr = loadCases();
              let ok = 0;

              rows.forEach(r => {
                const caseNumber = String(r["案件编号"]||"").trim();
                const enterpriseName = String(r["企业名称"]||"").trim();
                const enterpriseType = String(r["企业类型"]||"").trim();
                const caseName = String(r["案件名称"]||"").trim();
                const handlerName = String(r["办案人"]||"").trim();
                const registerDate = String(r["立案日期"]||"").trim();

                if(!caseNumber || !enterpriseName || !enterpriseType || !caseName || !handlerName || !registerDate) return;

                const id = String(Date.now()) + "_" + Math.random().toString(36).slice(2,8);
                const nowIso = new Date().toISOString();

                arr.unshift({
                  id,
                  caseNumber, enterpriseName, enterpriseType, caseName, handlerName,
                  registerDate,
                  progress: 1,
                  dates: { registerDate },
                  progressLogs: [{ progressId: 1, progressName: PROGRESS_MAP[1], date: registerDate, ts: nowIso, remark: "" }],
                  documentChecklist: {},
                  uploadedFiles: []
                });
                ok++;
              });

              saveCases(arr);
              renderTable(arr);
              alert("导入完成：" + ok + " 条。");
            }catch{
              alert("导入失败：Excel解析异常。");
            }
          };
          reader.readAsArrayBuffer(file);
        };
        input.click();
      }catch{
        alert("导入失败：库加载异常。");
      }
    });

    document.getElementById("btnExport").addEventListener("click", async () => {
      try{
        await ensureXLSX();
        const arr = loadCases();
        if(!arr.length){
          alert("暂无数据可导出。");
          return;
        }
        const out = arr.map(item => {
          const due = getDueInfo(item);
          const remain = due.date ? diffDays(due.date) : null;
          return {
            "案件编号": item.caseNumber,
            "企业名称": item.enterpriseName,
            "企业类型": item.enterpriseType,
            "案件名称": item.caseName,
            "办案人": item.handlerName,
            "立案日期": item.registerDate,
            "当前进度": PROGRESS_MAP[item.progress] || "",
            "截止事项": due.label || "",
            "截止日期": due.date || "",
            "剩余": remainText(remain),
            "决定最晚日": getDecisionMaxDate(item),
            "告知最晚日": getNoticeLatestDate(item)
          };
        });
        const ws = XLSX.utils.json_to_sheet(out);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "案件数据");
        XLSX.writeFile(wb, `案件数据_${fmt(new Date())}.xlsx`);
      }catch{
        alert("导出失败。");
      }
    });

    /*************** 刷新/筛选按钮 ***************/
    document.getElementById("btnRefresh").addEventListener("click", () => renderTable(loadCases()));
    document.getElementById("btnFilter").addEventListener("click", applyFilter);
    document.getElementById("btnReset").addEventListener("click", resetFilter);

    document.getElementById("registerDate").addEventListener("change", () => {
      const rd = document.getElementById("registerDate").value;
      document.getElementById("kpiDecisionMax").textContent = rd ? ("决定最晚日：" + addDays(rd, 90)) : "决定最晚日：—";
    });

    /*************** 弹窗通用 ***************/
    function showModal(id){
      const m = document.getElementById(id);
      m.style.display = "block";
      m.setAttribute("aria-hidden","false");
    }
    function hideModal(id){
      const m = document.getElementById(id);
      m.style.display = "none";
      m.setAttribute("aria-hidden","true");
    }
    window.addEventListener("click", (e) => {
      const u = document.getElementById("updateModal");
      const d = document.getElementById("detailModal");
      const p = document.getElementById("previewModal");
      if(e.target === u) closeUpdate();
      if(e.target === d) closeDetail();
      if(e.target === p) hideModal("previewModal");
    });

    /*************** 初始化 ***************/
    (function init(){
      initProgressFilter();
      const arr = loadCases();
      updateCaseCount(arr.length);
      renderTable(arr);
      document.getElementById("badgeFiltered").textContent = "全部";
    })();
  </script>
</body>
</html>
