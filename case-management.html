<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>æ‰˜é‡Œå¿åº”æ€¥ç®¡ç†å±€ï½œæ¡ˆä»¶ç®¡ç†</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #2563eb; --primary-hover: #1d4ed8; --primary-light: #eff6ff;
      --danger: #dc2626; --danger-bg: #fef2f2;
      --warning: #f59e0b; --warning-bg: #fffbeb;
      --success: #10b981; --success-bg: #ecfdf5;
      --bg-body: #f8fafc; --surface: #ffffff;
      --text-main: #0f172a; --text-muted: #64748b; --border: #e2e8f0;
      --radius-md: 12px; --shadow-card: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; font-family: "Microsoft YaHei", sans-serif; background: var(--bg-body); color: var(--text-main); padding-bottom: 60px; }
    
    .app-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 16px 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-card); margin-bottom: 20px; border: 1px solid var(--border); }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon { width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg, var(--primary), var(--danger)); color: #fff; display: grid; place-items: center; font-weight: bold; }
    .brand-text h1 { margin: 0; font-size: 18px; font-weight: 700; }
    
    /* Stats */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius-md); border: 1px solid var(--border); display: flex; flex-direction: column; }
    .stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-value { font-size: 28px; font-weight: 800; }
    .stat-card.alert .stat-value { color: var(--danger); }
    
    /* Toolbar & Table */
    .toolbar { background: var(--surface); padding: 16px; border-radius: var(--radius-md) var(--radius-md) 0 0; border: 1px solid var(--border); display: flex; gap: 12px; flex-wrap: wrap; }
    .search-box { flex: 1; min-width: 200px; }
    .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; }
    
    .table-container { background: var(--surface); border: 1px solid var(--border); border-top: none; border-radius: 0 0 var(--radius-md) var(--radius-md); overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f1f5f9; text-align: left; padding: 12px 16px; font-size: 12px; color: var(--text-muted); position: sticky; top: 0; }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
    tr:hover td { background: var(--bg-body); }
    
    .badge { display: inline-flex; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; }
    .badge.blue { background: var(--primary-light); color: var(--primary); }
    .badge.red { background: var(--danger-bg); color: var(--danger); }
    .badge.orange { background: var(--warning-bg); color: var(--warning); }
    .badge.purple { background: #f3e8ff; color: #7e22ce; } /* äº‹æ•…ä¸“ç”¨ */
    
    .btn { padding: 10px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s; }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.outline { background: #fff; border: 1px solid var(--border); color: var(--text-main); }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.5); backdrop-filter: blur(4px); z-index: 100; display: none; place-items: center; padding: 20px; }
    .modal-overlay.open { display: grid; }
    .modal-content { background: var(--surface); width: 100%; max-width: 900px; max-height: 90vh; overflow-y: auto; border-radius: var(--radius-md); box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--surface); z-index: 10; }
    .modal-body { padding: 24px; }
    
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .form-group label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; }
    .tabs { display: flex; gap: 4px; border-bottom: 1px solid var(--border); margin-bottom: 20px; }
    .tab-btn { padding: 10px 16px; border: none; background: none; cursor: pointer; border-bottom: 2px solid transparent; font-weight: 600; color: var(--text-muted); }
    .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
    .tab-pane { display: none; } .tab-pane.active { display: block; }

    /* Toast */
    #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: var(--surface); padding: 12px 16px; border-radius: 6px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); display: flex; gap: 10px; font-size: 14px; animation: slideIn 0.3s; }
    .toast.error { border-left-color: var(--danger); }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
  </style>
</head>
<body>
  <div id="toast-container"></div>
  <div class="app-container">
    <header class="header">
      <div class="brand">
        <div class="brand-icon">å®‰</div>
        <div class="brand-text"><h1>æ¡ˆä»¶ç®¡ç†ç³»ç»Ÿ</h1><span style="font-size:12px;color:#64748b">v2.1 äº‹æ•…æ¡ˆä»¶å¢å¼ºç‰ˆ</span></div>
      </div>
      <div>
        <a href="./index.html" class="btn outline">ğŸ  è¿”å›é¦–é¡µ</a>
        <button class="btn outline" id="btnExport">ğŸ“¥ å¯¼å‡ºExcel</button>
        <button class="btn primary" id="btnNewCase">ï¼‹ æ–°å¢æ¡ˆä»¶</button>
      </div>
    </header>

    <div class="dashboard-grid">
      <div class="stat-card"><span class="stat-label">æ¡ˆä»¶æ€»æ•°</span><span class="stat-value" id="kpi-total">-</span></div>
      <div class="stat-card alert"><span class="stat-label">å·²é€¾æœŸ</span><span class="stat-value" id="kpi-overdue">-</span></div>
      <div class="stat-card"><span class="stat-label">äº‹æ•…æ¡ˆä»¶</span><span class="stat-value" id="kpi-accident" style="color:#7e22ce">-</span></div>
      <div class="stat-card"><span class="stat-label">æ­£å¸¸è¿›åº¦</span><span class="stat-value" id="kpi-normal" style="color:var(--success)">-</span></div>
    </div>

    <div class="toolbar">
      <input id="searchInput" class="form-input search-box" placeholder="æœç´¢ï¼šç¼–å·ã€ä¼ä¸šã€åŠæ¡ˆäºº..." />
      <select id="filterType" class="form-select" style="width:auto">
        <option value="">æ‰€æœ‰ç±»å‹</option>
        <option value="çŸ¿å±±">çŸ¿å±±</option>
        <option value="å±åŒ–">å±åŒ–</option>
        <option value="å·¥è´¸">å·¥è´¸</option>
        <option value="çƒŸèŠ±çˆ†ç«¹">çƒŸèŠ±çˆ†ç«¹</option>
        <option value="äº‹æ•…æ¡ˆä»¶">äº‹æ•…æ¡ˆä»¶(60æ—¥)</option>
      </select>
    </div>

    <div class="table-container">
      <table>
        <thead><tr><th>æ¡ˆä»¶ä¿¡æ¯</th><th>ç±»å‹</th><th>åŠæ¡ˆäºº</th><th>å½“å‰è¿›åº¦</th><th>æ³•å®šæˆªæ­¢</th><th>å‰©ä½™å¤©æ•°</th><th style="text-align:right">æ“ä½œ</th></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <div class="modal-overlay" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0">æ¡ˆä»¶è¯¦æƒ…</h3>
        <button class="btn outline" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="tabs">
          <button class="tab-btn active" data-tab="t-base">åŸºæœ¬ä¿¡æ¯</button>
          <button class="tab-btn" data-tab="t-progress">è¿›åº¦è®°å½•</button>
          <button class="tab-btn" data-tab="t-files">é™„ä»¶(DB)</button>
        </div>
        
        <div id="t-base" class="tab-pane active">
          <div class="form-grid">
            <div class="form-group"><label>æ¡ˆä»¶ç¼–å·</label><input class="form-input" id="inp_caseNumber"></div>
            <div class="form-group"><label>ä¼ä¸šåç§°</label><input class="form-input" id="inp_entName"></div>
            <div class="form-group">
              <label>ä¼ä¸šç±»å‹</label>
              <select class="form-select" id="inp_entType">
                <option value="çŸ¿å±±">çŸ¿å±±</option>
                <option value="å±åŒ–">å±åŒ–</option>
                <option value="å·¥è´¸">å·¥è´¸</option>
                <option value="çƒŸèŠ±çˆ†ç«¹">çƒŸèŠ±çˆ†ç«¹</option>
                <option value="äº‹æ•…æ¡ˆä»¶">äº‹æ•…æ¡ˆä»¶ (60æ—¥é™)</option>
              </select>
            </div>
            <div class="form-group"><label>ç«‹æ¡ˆæ—¥æœŸ</label><input type="date" class="form-input" id="inp_regDate"></div>
            <div class="form-group"><label>åŠæ¡ˆäººå‘˜</label><input class="form-input" id="inp_handler"></div>
            <div class="form-group">
              <label>æœŸé™è®¾ç½®</label>
              <select class="form-select" id="inp_limit">
                <option value="90">90æ—¥ (ä¸€èˆ¬ç¨‹åº)</option>
                <option value="180">180æ—¥ (å»¶é•¿)</option>
              </select>
              <div id="accidentHint" style="font-size:12px;color:#dc2626;margin-top:4px;display:none">âš ï¸ äº‹æ•…æ¡ˆä»¶å¼ºåˆ¶é”å®š60æ—¥</div>
            </div>
          </div>
          <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px">
            <button class="btn primary" style="background:var(--danger)" id="btnDelete">åˆ é™¤</button>
            <button class="btn primary" id="btnSaveBase">ä¿å­˜</button>
          </div>
        </div>

        <div id="t-progress" class="tab-pane">
          <div style="background:#f1f5f9;padding:15px;border-radius:8px;margin-bottom:15px;display:flex;justify-content:space-between">
            <div>å½“å‰ï¼š<b id="view_stage">-</b></div>
            <div>ä¸‹ä¸€é˜¶æ®µï¼š<b id="view_next_stage" style="color:var(--primary)">-</b></div>
          </div>
          <div style="display:flex;gap:10px;margin-bottom:20px">
            <input type="date" class="form-input" id="inp_progDate" style="width:auto">
            <input class="form-input" id="inp_progNote" placeholder="è¿›åº¦è¯´æ˜">
            <button class="btn primary" id="btnUpdateProg">æ›´æ–°è¿›åº¦</button>
          </div>
          <div id="timelineList" style="border-left:2px solid #e2e8f0;padding-left:15px;margin-left:5px"></div>
        </div>

        <div id="t-files" class="tab-pane">
          <div style="background:#ecfdf5;color:#065f46;padding:10px;border-radius:6px;font-size:13px;margin-bottom:15px">
             âœ… å·²å¯ç”¨ IndexedDB æœ¬åœ°æ•°æ®åº“æŠ€æœ¯ï¼Œæ”¯æŒå­˜å‚¨å¤§æ–‡ä»¶ä¸”ä¸å¡é¡¿ã€‚
          </div>
          <div style="display:flex;gap:10px;margin-bottom:15px">
            <input type="file" id="inp_file" class="form-input">
            <button class="btn primary" id="btnUploadFile">ä¸Šä¼ </button>
          </div>
          <div id="fileListArea"></div>
        </div>
      </div>
    </div>
  </div>

<script>
// --- DB & Logic ---
const DB_CFG = { name:'EmgCaseDB_v2', ver:1, store:'cases', fileStore:'files' };
class DB {
  async open(){
    return new Promise((res,rej)=>{
      const r = indexedDB.open(DB_CFG.name, DB_CFG.ver);
      r.onupgradeneeded = e => {
        const d = e.target.result;
        if(!d.objectStoreNames.contains(DB_CFG.store)) d.createObjectStore(DB_CFG.store, {keyPath:'id'});
        if(!d.objectStoreNames.contains(DB_CFG.fileStore)) d.createObjectStore(DB_CFG.fileStore, {keyPath:'id'}).createIndex('cid','cid');
      };
      r.onsuccess = e => res(e.target.result);
      r.onerror = e => rej(e);
    });
  }
  async tx(store, mode, cb){
    const db = await this.open();
    return new Promise((res,rej)=>{
      const t = db.transaction(store, mode);
      const req = cb(t.objectStore(store));
      req.onsuccess = () => res(req.result);
      req.onerror = () => rej(req.error);
    });
  }
  async getAll(){ return this.tx(DB_CFG.store, 'readonly', s=>s.getAll()); }
  async put(data){ return this.tx(DB_CFG.store, 'readwrite', s=>s.put(data)); }
  async del(id){
    const db = await this.open();
    const tx = db.transaction([DB_CFG.store, DB_CFG.fileStore], 'readwrite');
    tx.objectStore(DB_CFG.store).delete(id);
    const idx = tx.objectStore(DB_CFG.fileStore).index('cid');
    idx.getAllKeys(id).onsuccess = e => {
      e.target.result.forEach(k => tx.objectStore(DB_CFG.fileStore).delete(k));
    };
    return new Promise(r => tx.oncomplete = r);
  }
  async addFile(f){ return this.tx(DB_CFG.fileStore, 'readwrite', s=>s.put(f)); }
  async getFiles(cid){
    const db = await this.open();
    return new Promise(res => {
      const idx = db.transaction(DB_CFG.fileStore,'readonly').objectStore(DB_CFG.fileStore).index('cid');
      idx.getAll(cid).onsuccess = e => res(e.target.result);
    });
  }
  async delFile(fid){ return this.tx(DB_CFG.fileStore, 'readwrite', s=>s.delete(fid)); }
}
const db = new DB();

const STAGES = [
  {id:1,name:"ç«‹æ¡ˆ/äº‹æ•…å‘ç”Ÿ"}, {id:2,name:"è°ƒæŸ¥å–è¯"}, {id:3,name:"äº‹å…ˆå‘ŠçŸ¥"}, 
  {id:4,name:"å†³å®š/æŠ¥å‘Šæäº¤"}, {id:5,name:"é€è¾¾/ç»“æ¡ˆ"}, {id:6,name:"å½’æ¡£å®Œæˆ"}
];

// UI Logic
let cases=[], curId=null;

function toast(msg, type=''){
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<span>${type==='error'?'âš ï¸':'âœ…'}</span> ${msg}`;
  document.getElementById('toast-container').appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

function getDead(c){
  if(!c.registerDate) return {days:null, date:'-'};
  const start = new Date(c.registerDate);
  // æ ¸å¿ƒé€»è¾‘ï¼šäº‹æ•…æ¡ˆä»¶å¼ºåˆ¶60å¤©ï¼Œå…¶ä»–æŒ‰è®¾å®š
  const limit = (c.entType === 'äº‹æ•…æ¡ˆä»¶') ? 60 : parseInt(c.decisionLimit||90);
  start.setDate(start.getDate() + limit);
  const now = new Date(); now.setHours(0,0,0,0);
  const days = Math.ceil((start - now)/(86400000));
  return { days, date: start.toISOString().split('T')[0], isAccident: c.entType === 'äº‹æ•…æ¡ˆä»¶' };
}

async function load(){
  cases = await db.getAll();
  cases.sort((a,b)=>(b.updated||'').localeCompare(a.updated||''));
  render();
  // KPI
  let total=cases.length, over=0, acc=0, norm=0;
  cases.forEach(c=>{
    if(c.entType==='äº‹æ•…æ¡ˆä»¶') acc++;
    if(c.stage>=6) return;
    const d = getDead(c).days;
    if(d<=0) over++; else norm++;
  });
  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-overdue').textContent = over;
  document.getElementById('kpi-accident').textContent = acc;
  document.getElementById('kpi-normal').textContent = norm;
}

function render(){
  const body = document.getElementById('tableBody');
  const q = document.getElementById('searchInput').value.trim();
  const fType = document.getElementById('filterType').value;
  
  body.innerHTML = cases.filter(c => {
    return (!q || (c.caseNumber+c.entName).includes(q)) && (!fType || c.entType===fType);
  }).map(c => {
    const d = getDead(c);
    const sName = STAGES.find(x=>x.id===c.stage)?.name||'-';
    let badge = d.days<=0 ? 'red' : (d.days<=7 ? 'orange' : 'blue');
    if(c.stage>=6) badge='blue';
    const typeBadge = c.entType==='äº‹æ•…æ¡ˆä»¶' ? 'badge purple' : 'badge gray';
    
    return `<tr>
      <td><b>${c.entName}</b><div style="font-size:12px;color:#64748b">${c.caseNumber}</div></td>
      <td><span class="${typeBadge}">${c.entType}</span></td>
      <td>${c.handler}</td>
      <td><span style="color:#2563eb;font-weight:bold">${sName}</span></td>
      <td>${d.date} ${d.isAccident?'<span style="font-size:10px;color:red">(60æ—¥)</span>':''}</td>
      <td>${c.stage>=6 ? 'å·²ç»“æ¡ˆ' : `<span class="badge ${badge}">${d.days}å¤©</span>`}</td>
      <td style="text-align:right"><button class="btn outline" onclick="openDetail('${c.id}')">è¯¦æƒ…</button></td>
    </tr>`;
  }).join('') || '<tr><td colspan="7" style="text-align:center;padding:20px;color:#94a3b8">æ— æ•°æ®</td></tr>';
}

// Event Listeners
document.getElementById('btnNewCase').onclick = () => {
  curId = null;
  ['inp_caseNumber','inp_entName','inp_handler','inp_regDate'].forEach(i=>document.getElementById(i).value='');
  document.getElementById('inp_limit').value = "90";
  document.getElementById('inp_entType').value = "çŸ¿å±±";
  document.getElementById('accidentHint').style.display='none';
  document.getElementById('inp_limit').disabled = false;
  document.getElementById('timelineList').innerHTML='';
  document.getElementById('fileListArea').innerHTML='';
  document.getElementById('detailModal').classList.add('open');
};

document.getElementById('inp_entType').onchange = (e) => {
  const isAcc = e.target.value === 'äº‹æ•…æ¡ˆä»¶';
  const limitSel = document.getElementById('inp_limit');
  const hint = document.getElementById('accidentHint');
  
  if(isAcc){
    limitSel.disabled = true;
    hint.style.display = 'block';
    toast('âš ï¸ å·²é€‰æ‹©äº‹æ•…æ¡ˆä»¶ï¼Œæ—¶é™è‡ªåŠ¨é”å®šä¸º60æ—¥ï¼', 'error');
  } else {
    limitSel.disabled = false;
    hint.style.display = 'none';
  }
};

window.openDetail = async (id) => {
  curId = id;
  const c = cases.find(x=>x.id===id);
  document.getElementById('inp_caseNumber').value = c.caseNumber;
  document.getElementById('inp_entName').value = c.entName;
  document.getElementById('inp_entType').value = c.entType;
  document.getElementById('inp_regDate').value = c.registerDate;
  document.getElementById('inp_handler').value = c.handler;
  document.getElementById('inp_limit').value = c.decisionLimit;
  
  // Trigger logic for accident lock
  const isAcc = c.entType === 'äº‹æ•…æ¡ˆä»¶';
  document.getElementById('inp_limit').disabled = isAcc;
  document.getElementById('accidentHint').style.display = isAcc ? 'block' : 'none';

  document.getElementById('view_stage').textContent = STAGES.find(x=>x.id===c.stage)?.name;
  document.getElementById('view_next_stage').textContent = STAGES.find(x=>x.id===c.stage+1)?.name || 'æ— ';
  
  const tl = document.getElementById('timelineList');
  tl.innerHTML = (c.timeline||[]).map(t=>`<div style="margin-top:10px"><div style="font-size:12px;color:#64748b">${t.date}</div><div>${t.text}</div></div>`).join('');
  
  renderFiles(id);
  document.getElementById('detailModal').classList.add('open');
};

window.closeModal = () => document.getElementById('detailModal').classList.remove('open');

document.getElementById('btnSaveBase').onclick = async () => {
  const data = {
    id: curId || Date.now().toString(),
    caseNumber: document.getElementById('inp_caseNumber').value,
    entName: document.getElementById('inp_entName').value,
    entType: document.getElementById('inp_entType').value,
    registerDate: document.getElementById('inp_regDate').value,
    handler: document.getElementById('inp_handler').value,
    decisionLimit: document.getElementById('inp_limit').value,
    updated: new Date().toISOString()
  };
  
  if(!data.entName) return toast('ä¼ä¸šåç§°å¿…å¡«','error');
  
  if(!curId){
    data.stage = 1;
    data.timeline = [{date:new Date().toISOString().split('T')[0], text:'æ¡ˆä»¶å»ºç«‹'}];
    curId = data.id;
  } else {
    const old = cases.find(x=>x.id===curId);
    data.stage = old.stage; data.timeline = old.timeline;
  }
  
  await db.put(data);
  toast('ä¿å­˜æˆåŠŸ');
  load();
};

document.getElementById('btnUpdateProg').onclick = async () => {
  if(!curId) return;
  const c = cases.find(x=>x.id===curId);
  const note = document.getElementById('inp_progNote').value;
  const date = document.getElementById('inp_progDate').value || new Date().toISOString().split('T')[0];
  
  if(c.stage < 6) c.stage++;
  c.timeline.push({date, text:`${STAGES.find(x=>x.id===c.stage)?.name}ï¼š${note}`});
  c.updated = new Date().toISOString();
  await db.put(c);
  toast('è¿›åº¦å·²æ›´æ–°');
  openDetail(curId); // refresh
  load();
};

document.getElementById('btnDelete').onclick = async () => {
  if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿæ— æ³•æ¢å¤ï¼')) return;
  await db.del(curId);
  closeModal();
  load();
};

// File Logic
document.getElementById('btnUploadFile').onclick = async () => {
  if(!curId) return toast('è¯·å…ˆä¿å­˜åŸºæœ¬ä¿¡æ¯','error');
  const file = document.getElementById('inp_file').files[0];
  if(!file) return;
  
  await db.addFile({
    id: Date.now().toString(), cid: curId,
    name: file.name, type: file.type, blob: file,
    date: new Date().toISOString()
  });
  toast('ä¸Šä¼ æˆåŠŸ');
  renderFiles(curId);
};

async function renderFiles(cid){
  const files = await db.getFiles(cid);
  const box = document.getElementById('fileListArea');
  box.innerHTML = files.map(f=>`
    <div style="display:flex;justify-content:space-between;background:#f8fafc;padding:8px;margin-top:5px;border:1px solid #e2e8f0">
      <a href="#" onclick="dlFile('${f.id}')">${f.name}</a>
      <span style="color:red;cursor:pointer" onclick="rmFile('${f.id}')">åˆ é™¤</span>
    </div>
  `).join('');
}

window.dlFile = async (fid) => {
  const db_ = await db.open();
  const f = await new Promise(r=>db_.transaction(DB_CFG.fileStore).objectStore(DB_CFG.fileStore).get(fid).onsuccess=e=>r(e.target.result));
  const url = URL.createObjectURL(f.blob);
  const a = document.createElement('a'); a.href=url; a.download=f.name; a.click();
};

window.rmFile = async (fid) => {
  if(confirm('åˆ é™¤æ–‡ä»¶ï¼Ÿ')) { await db.delFile(fid); renderFiles(curId); }
};

// Init
document.getElementById('inp_regDate').value = new Date().toISOString().split('T')[0];
document.getElementById('filterType').onchange = load;
document.getElementById('searchInput').oninput = load;
load();
</script>
</body>
</html>
