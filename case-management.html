<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>托里县应急管理局｜案件管理</title>
  <style>
    :root{
      --bg:#f3f6fb;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#516078;
      --line:#e3eaf6;
      --blue:#1d4ed8;
      --red:#dc2626;
      --amber:#f59e0b;
      --green:#16a34a;
      --shadow:0 18px 50px rgba(2,6,23,.12);
      --radius:22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Microsoft YaHei",system-ui,-apple-system,Segoe UI,Arial;
      color:var(--text);
      background:
        radial-gradient(1100px 520px at 20% 0%, rgba(29,78,216,.10), transparent 60%),
        radial-gradient(900px 520px at 80% 10%, rgba(220,38,38,.09), transparent 55%),
        linear-gradient(180deg, #f6f9ff 0%, #f3f6fb 45%, #eef3fb 100%);
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:1600px;margin:0 auto;padding:26px 22px 56px}

    /* 顶部大标题区 */
    .topbar{
      position:relative;
      border:1px solid var(--line);
      border-radius:28px;
      background:linear-gradient(135deg, rgba(29,78,216,.12), rgba(220,38,38,.10));
      box-shadow:var(--shadow);
      overflow:hidden;
      padding:18px 18px;
    }
    .topbar::before{
      content:"";
      position:absolute;right:-110px;top:-110px;
      width:420px;height:420px;border-radius:999px;
      background:radial-gradient(circle at 30% 30%, rgba(220,38,38,.18), transparent 60%);
      filter:blur(2px);
    }
    .topbar::after{
      content:"";
      position:absolute;left:-120px;top:-120px;
      width:420px;height:420px;border-radius:999px;
      background:radial-gradient(circle at 40% 40%, rgba(29,78,216,.18), transparent 62%);
      filter:blur(2px);
    }
    .topInner{position:relative;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:16px}
    .emblem{
      width:60px;height:60px;border-radius:18px;
      background:linear-gradient(135deg, var(--blue), var(--red));
      box-shadow:0 24px 42px rgba(29,78,216,.22);
      display:grid;place-items:center;color:#fff;flex:0 0 auto;
    }
    .brandText h1{margin:0;font-size:22px;font-weight:1000;letter-spacing:.3px}
    .brandText .sub{margin-top:6px;font-size:13px;font-weight:900;color:rgba(11,18,32,.70)}
    .stripe{
      margin-top:14px;height:12px;border-radius:999px;
      background:repeating-linear-gradient(135deg, rgba(220,38,38,.95) 0 14px, rgba(220,38,38,.95) 14px 28px, rgba(29,78,216,.95) 28px 42px, rgba(29,78,216,.95) 42px 56px);
      opacity:.55;
    }

    /* 按钮 */
    .topActions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:none;border-radius:18px;
      padding:14px 16px;
      cursor:pointer;font-weight:1000;
      display:inline-flex;align-items:center;gap:10px;
      background:var(--blue);color:#fff;font-size:14px;
      transition:transform .08s ease, filter .08s ease;
      box-shadow:0 18px 40px rgba(29,78,216,.16);
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.03)}
    .btn.dark{background:#0b1220;box-shadow:0 18px 40px rgba(2,6,23,.16)}
    .btn.ghost{background:#fff;color:#0b1220;border:1px solid var(--line);box-shadow:none}
    .btn.red{background:var(--red);box-shadow:0 18px 40px rgba(220,38,38,.16)}
    .btn.green{background:#10b981}
    .btn.purple{background:#8b5cf6}
    .btn.orange{background:#f97316}

    /* 主体布局更大气 */
    .grid{display:grid;grid-template-columns:520px 1fr;gap:18px;margin-top:18px}
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:28px;
      padding:22px;
      box-shadow:var(--shadow);
    }
    .sectionTitle{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:14px;gap:10px}
    .sectionTitle h2{margin:0;font-size:16px;font-weight:1000}
    .hint{color:var(--muted);font-size:12px;font-weight:800}
    label{font-weight:1000;color:#0b1220;font-size:12px}
    input,select,textarea{
      padding:14px 14px;border-radius:18px;border:1px solid var(--line);
      font-size:14px;outline:none;background:#fff;
    }
    textarea{resize:vertical;min-height:110px}
    .field{display:flex;flex-direction:column;gap:8px;margin-bottom:14px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}

    /* 过滤区更大 */
    .filters{
      display:grid;
      grid-template-columns:1.4fr 1fr 1fr 1fr auto auto;
      gap:12px;align-items:end
    }

    /* KPI */
    .kpiRow{display:flex;gap:12px;flex-wrap:wrap;margin:14px 0}
    .kpi{
      flex:1 1 200px;
      border:1px solid var(--line);
      border-radius:22px;
      padding:14px 16px;
      background:#fff;
    }
    .kpi .n{font-size:22px;font-weight:1000}
    .kpi .t{font-size:12px;color:var(--muted);font-weight:900;margin-top:6px}

    /* 表格更易看 */
    .tablewrap{border:1px solid var(--line);border-radius:22px;overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:1120px}
    thead th{
      position:sticky;top:0;background:#f8fbff;border-bottom:1px solid var(--line);
      padding:14px 14px;font-size:12px;text-align:left;color:#0b1220;font-weight:1000;
    }
    tbody td{padding:14px;border-bottom:1px solid var(--line);font-size:14px;vertical-align:top}
    tbody tr:hover{background:#f8fbff}
    .statusText{font-weight:1000}
    .muted{color:var(--muted);font-size:12px;font-weight:800;line-height:1.6;margin-top:4px}

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 14px;border-radius:999px;
      border:1px solid rgba(29,78,216,.22);
      background:rgba(29,78,216,.08);
      color:var(--blue);font-weight:1000;font-size:12px;
      white-space:nowrap;
    }
    .pill.stage-warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.30);color:#92400e}
    .pill.stage-over{background:rgba(220,38,38,.12);border-color:rgba(220,38,38,.30);color:var(--red)}
    .pill.stage-invest{background:rgba(29,78,216,.12);border-color:rgba(29,78,216,.30);color:var(--blue)}

    /* Modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,.58);z-index:2000;padding:20px;overflow:auto}
    .modalContent{
      max-width:1100px;margin:0 auto;background:#fff;border-radius:28px;
      border:1px solid var(--line);box-shadow:var(--shadow);padding:18px;
    }
    .modalHead{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .modalHead h3{margin:0;font-size:18px;font-weight:1000}
    .xbtn{cursor:pointer;font-size:28px;line-height:1;color:#64748b}
    .xbtn:hover{color:var(--red)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .tabBtn{
      padding:12px 14px;border-radius:18px;border:1px solid var(--line);
      background:#fff;font-weight:1000;cursor:pointer;font-size:13px;color:#0b1220;
    }
    .tabBtn.active{background:rgba(29,78,216,.10);border-color:rgba(29,78,216,.28);color:var(--blue)}
    .tab{display:none}
    .tab.active{display:block}

    .timelineItem{
      border-left:4px solid rgba(29,78,216,.60);
      padding:12px 12px 12px 14px;margin-bottom:12px;background:#f8fbff;
      border-radius:18px;
    }
    .timelineItem .tt{font-weight:1000;font-size:14px}
    .timelineItem .dd{font-size:12px;color:var(--muted);font-weight:800;margin-top:6px;line-height:1.6}

    .checklist{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .chk{
      display:flex;gap:10px;align-items:flex-start;
      border:1px solid var(--line);border-radius:18px;padding:12px;background:#fff;
    }
    .chk input{margin-top:4px}
    .chk label{font-weight:1000;font-size:12px;line-height:1.4}

    .fileBox{border:1px dashed rgba(29,78,216,.35);border-radius:18px;padding:14px;background:rgba(29,78,216,.04)}
    .fileRow{display:grid;grid-template-columns:1fr 240px;gap:12px;align-items:end;margin-top:10px}
    .fileListItem{border:1px solid var(--line);border-radius:18px;padding:12px;background:#fff;margin-top:12px}

    .confirmBox{
      border:1px solid rgba(245,158,11,.30);
      background:rgba(245,158,11,.08);
      border-radius:18px;padding:14px;margin-top:12px;
    }
    .confirmBox .line{display:flex;gap:10px;align-items:flex-start;margin-top:10px}
    .confirmBox input{margin-top:4px}

    @media (max-width: 1100px){
      .grid{grid-template-columns:1fr}
      .filters{grid-template-columns:1fr 1fr}
      table{min-width:1120px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="topbar" aria-label="案件管理顶部">
      <div class="topInner">
        <div class="brand">
          <div class="emblem" aria-hidden="true">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
              <path d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4z" stroke="white" stroke-width="2" />
              <path d="M8 12l2.2 2.2L16 8.5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div class="brandText">
            <h1>托里县应急管理局｜案件管理</h1>
            <div class="sub">行政处罚案件进度与期限</div>
          </div>
        </div>

        <div class="topActions">
          <a class="btn ghost" href="./index.html">返回首页</a>
          <button class="btn dark" id="btnSettings">系统设置</button>
          <button class="btn orange" id="btnBackupJson">备份JSON</button>
          <button class="btn green" id="btnRestoreJson">恢复JSON</button>
          <button class="btn purple" id="btnExportXlsx">导出Excel</button>
          <button class="btn green" id="btnImportXlsx">导入Excel</button>
        </div>
      </div>
      <div class="stripe" aria-hidden="true"></div>
    </section>

    <div class="grid">
      <!-- 新增案件 -->
      <section class="card" aria-label="新增案件">
        <div class="sectionTitle">
          <h2>新增案件</h2>
          <div class="hint">必填项请完整填写</div>
        </div>

        <div class="row2">
          <div class="field">
            <label>案件编号 *</label>
            <input id="caseNumber" placeholder="例：托应急罚〔2025〕001号" />
          </div>
          <div class="field">
            <label>企业名称 *</label>
            <input id="enterpriseName" placeholder="涉事企业全称" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>企业类型 *</label>
            <select id="enterpriseType">
              <option value="">请选择</option>
              <option value="矿山">矿山</option>
              <option value="危化">危化</option>
              <option value="工贸">工贸</option>
              <option value="烟花爆竹">烟花爆竹</option>
            </select>
          </div>
          <div class="field">
            <label>案件名称 *</label>
            <input id="caseName" placeholder="例：XX企业违规动火案" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>立案日期 *</label>
            <input id="registerDate" type="date" />
          </div>
          <div class="field">
            <label>办案人 *</label>
            <input id="handlerName" placeholder="多人用 / 分隔" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>处罚决定期限（硬上限）*</label>
            <select id="decisionLimit">
              <option value="90" selected>90日</option>
              <option value="180">180日</option>
            </select>
          </div>
          <div class="field">
            <label>调查取证期限 *</label>
            <select id="investigationLimit">
              <option value="30" selected>30日</option>
              <option value="60">60日</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>备注（选填）</label>
          <textarea id="caseRemark" placeholder="可记录案情要点、联系人、关键风险等"></textarea>
        </div>

        <button class="btn" id="btnAddCase">添加案件</button>
      </section>

      <!-- 列表 -->
      <section class="card" aria-label="案件列表">
        <div class="sectionTitle">
          <h2>案件进度列表</h2>
          <div class="hint" id="nowText"></div>
        </div>

        <div class="filters">
          <div class="field" style="margin:0">
            <label>搜索</label>
            <input id="q" placeholder="编号/企业/名称/办案人" />
          </div>
          <div class="field" style="margin:0">
            <label>企业类型</label>
            <select id="fType">
              <option value="">全部</option>
              <option value="矿山">矿山</option>
              <option value="危化">危化</option>
              <option value="工贸">工贸</option>
              <option value="烟花爆竹">烟花爆竹</option>
            </select>
          </div>
          <div class="field" style="margin:0">
            <label>当前进度</label>
            <select id="fStage"></select>
          </div>
          <div class="field" style="margin:0">
            <label>状态</label>
            <select id="fRisk">
              <option value="">全部</option>
              <option value="normal">正常</option>
              <option value="warning">临期（≤3天）</option>
              <option value="overdue">逾期</option>
            </select>
          </div>
          <button class="btn ghost" id="btnFilter">筛选</button>
          <button class="btn ghost" id="btnReset">重置</button>
        </div>

        <div class="kpiRow" id="kpiRow"></div>

        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>案件编号</th>
                <th>企业</th>
                <th>类型</th>
                <th>办案人</th>
                <th>当前进度</th>
                <th>截止类型</th>
                <th>截止日期</th>
                <th>剩余</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <!-- 详情弹窗（下方 JS 逻辑保持原版不动） -->
  <div class="modal" id="detailModal">
    <div class="modalContent">
      <div class="modalHead">
        <h3 id="detailTitle">案件详情</h3>
        <div class="xbtn" id="closeDetail">×</div>
      </div>

      <div class="tabs">
        <button class="tabBtn active" data-tab="tabBase">基本信息</button>
        <button class="tabBtn" data-tab="tabDates">关键日期</button>
        <button class="tabBtn" data-tab="tabTimeline">进度记录</button>
        <button class="tabBtn" data-tab="tabRemedy">整改跟踪</button>
        <button class="tabBtn" data-tab="tabDocs">文书清单</button>
        <button class="tabBtn" data-tab="tabFiles">文件</button>
      </div>

      <div class="tab active" id="tabBase">
        <div class="row2">
          <div class="field"><label>案件编号</label><div id="d_caseNumber" class="statusText">-</div></div>
          <div class="field"><label>企业名称</label><div id="d_enterpriseName" class="statusText">-</div></div>
        </div>
        <div class="row3">
          <div class="field"><label>企业类型</label><div id="d_enterpriseType" class="statusText">-</div></div>
          <div class="field"><label>办案人</label><div id="d_handlerName" class="statusText">-</div></div>
          <div class="field"><label>立案日期</label><div id="d_registerDate" class="statusText">-</div></div>
        </div>
        <div class="row3">
          <div class="field"><label>处罚决定期限</label><div id="d_decisionLimit" class="statusText">-</div></div>
          <div class="field"><label>调查取证期限</label><div id="d_investigationLimit" class="statusText">-</div></div>
          <div class="field"><label>当前进度</label><div id="d_stage" class="statusText">-</div></div>
        </div>
        <div class="field">
          <label>备注</label>
          <textarea id="d_remark"></textarea>
          <button class="btn ghost" id="btnSaveRemark" style="width:max-content">保存备注</button>
        </div>
      </div>

      <div class="tab" id="tabDates">
        <div class="row2">
          <div class="card" style="box-shadow:none;border-radius:22px">
            <div class="sectionTitle"><h2>硬上限与倒推</h2></div>
            <div class="row2">
              <div class="field"><label>决定最晚日</label><div id="d_decisionDeadline" class="statusText">-</div></div>
              <div class="field"><label>告知最晚日</label><div id="d_noticeLatest" class="statusText">-</div></div>
            </div>
            <div class="row2">
              <div class="field"><label>调查到期日</label><div id="d_investigationDeadline" class="statusText">-</div></div>
              <div class="field"><label>当前节点截止</label><div id="d_nodeDeadline" class="statusText">-</div></div>
            </div>
          </div>

          <div class="card" style="box-shadow:none;border-radius:22px">
            <div class="sectionTitle"><h2>决定后派生</h2></div>
            <div class="row2">
              <div class="field"><label>送达最晚日</label><div id="d_serveDeadline" class="statusText">-</div></div>
              <div class="field"><label>缴款最晚日</label><div id="d_payDeadline" class="statusText">-</div></div>
            </div>
            <div class="row2">
              <div class="field"><label>立卷最晚日（20个工作日）</label><div id="d_filingDeadline" class="statusText">-</div></div>
              <div class="field"><label>归档最晚日</label><div id="d_archiveDeadline" class="statusText">-</div></div>
            </div>
          </div>
        </div>

        <div class="card" style="box-shadow:none;border-radius:22px;margin-top:12px">
          <div class="sectionTitle"><h2>关键日期（登记）</h2></div>
          <div class="row3">
            <div class="field"><label>调查完成日</label><input type="date" id="k_investigationDone"></div>
            <div class="field"><label>集体讨论完成日</label><input type="date" id="k_discussionDone"></div>
            <div class="field"><label>告知送达日</label><input type="date" id="k_noticeServed"></div>
          </div>
          <div class="row3">
            <div class="field"><label>决定签发日</label><input type="date" id="k_decisionMade"></div>
            <div class="field"><label>决定书送达日</label><input type="date" id="k_decisionServed"></div>
            <div class="field"><label>缴款完成日</label><input type="date" id="k_finePaid"></div>
          </div>
          <div class="row3">
            <div class="field"><label>结案审批签署日</label><input type="date" id="k_closed"></div>
            <div class="field"><label>立卷完成日</label><input type="date" id="k_filed"></div>
            <div class="field"><label>归档完成日</label><input type="date" id="k_archived"></div>
          </div>
          <button class="btn ghost" id="btnSaveKeyDates" style="width:max-content">保存</button>
        </div>
      </div>

      <div class="tab" id="tabTimeline">
        <div id="timeline"></div>
      </div>

      <div class="tab" id="tabRemedy">
        <div class="card" style="box-shadow:none;border-radius:22px">
          <div class="sectionTitle"><h2>整改跟踪</h2></div>
          <div class="row3">
            <div class="field"><label>整改指令下达日</label><input type="date" id="r_issue"></div>
            <div class="field"><label>整改期限</label><input type="date" id="r_deadline"></div>
            <div class="field"><label>复查日</label><input type="date" id="r_review"></div>
          </div>
          <div class="row2">
            <div class="field">
              <label>整改结果</label>
              <select id="r_result">
                <option value="">请选择</option>
                <option value="已完成">已完成</option>
                <option value="未完成">未完成</option>
                <option value="部分完成">部分完成</option>
              </select>
            </div>
            <div class="field"><label>备注</label><input id="r_note" placeholder="选填"></div>
          </div>
          <button class="btn ghost" id="btnSaveRemedy" style="width:max-content">保存</button>
          <div class="hint" id="remedyHint" style="margin-top:10px"></div>
        </div>
      </div>

      <div class="tab" id="tabDocs">
        <div class="card" style="box-shadow:none;border-radius:22px">
          <div class="sectionTitle"><h2>文书清单</h2></div>
          <div class="checklist" id="docChecklist"></div>
          <button class="btn ghost" id="btnSaveDocs" style="width:max-content;margin-top:10px">保存</button>
        </div>
      </div>

      <div class="tab" id="tabFiles">
        <div class="card" style="box-shadow:none;border-radius:22px">
          <div class="sectionTitle"><h2>文件（选填）</h2></div>
          <div class="fileBox">
            <div class="row2">
              <div class="field" style="margin:0">
                <label>文件分类</label>
                <select id="f_cat">
                  <option value="现场检查记录">现场检查记录</option>
                  <option value="询问笔录">询问笔录</option>
                  <option value="行政处罚决定书">行政处罚决定书</option>
                  <option value="责令限期整改">责令限期整改</option>
                  <option value="送达回执">送达回执</option>
                  <option value="其他">其他</option>
                </select>
              </div>
              <div class="field" style="margin:0">
                <label>备注（选填）</label>
                <input id="f_note" placeholder="选填" />
              </div>
            </div>

            <div class="fileRow">
              <div class="field" style="margin:0">
                <label>选择文件</label>
                <input id="f_file" type="file" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
              </div>
              <button class="btn orange" id="btnUpload">上传</button>
            </div>
          </div>

          <div id="fileList"></div>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;justify-content:flex-end">
        <button class="btn red" id="btnDeleteCase">删除案件</button>
        <button class="btn dark" id="btnOpenUpdate">更新进度</button>
      </div>
    </div>
  </div>

  <!-- 更新进度弹窗 -->
  <div class="modal" id="updateModal">
    <div class="modalContent" style="max-width:900px">
      <div class="modalHead">
        <h3>更新进度</h3>
        <div class="xbtn" id="closeUpdate">×</div>
      </div>

      <div class="card" style="box-shadow:none;border-radius:22px">
        <div class="row2">
          <div class="field"><label>当前节点</label><div id="u_curr" class="statusText">-</div></div>
          <div class="field"><label>下一节点</label><div id="u_next" class="statusText">-</div></div>
        </div>
        <div class="row2">
          <div class="field"><label>本节点截止</label><div id="u_deadline" class="statusText">-</div></div>
          <div class="field"><label>决定最晚日</label><div id="u_decisionDeadline" class="statusText">-</div></div>
        </div>

        <div class="row2">
          <div class="field">
            <label>完成日期</label>
            <input type="date" id="u_doneDate" />
          </div>
          <div class="field">
            <label>备注（选填）</label>
            <input id="u_note" placeholder="选填" />
          </div>
        </div>

        <div class="confirmBox">
          <div class="statusText">确认</div>
          <div class="line">
            <input type="checkbox" id="u_chk1">
            <label for="u_chk1" style="font-weight:1000">当前节点工作已完成，进入下一节点。</label>
          </div>
          <div class="line" id="u_extraLine" style="display:none">
            <input type="checkbox" id="u_chk2">
            <label for="u_chk2" style="font-weight:1000;color:#92400e">存在异常提示，仍继续登记。</label>
          </div>
          <div class="hint" id="u_warnText" style="margin-top:10px"></div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
          <button class="btn ghost" id="u_cancel">取消</button>
          <button class="btn" id="u_confirm">确认更新</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 系统设置弹窗 -->
  <div class="modal" id="settingsModal">
    <div class="modalContent" style="max-width:900px">
      <div class="modalHead">
        <h3>系统设置</h3>
        <div class="xbtn" id="closeSettings">×</div>
      </div>
      <div class="card" style="box-shadow:none;border-radius:22px">
        <div class="sectionTitle"><h2>节假日（用于20个工作日计算）</h2></div>
        <div class="field" style="margin-top:10px">
          <label>节假日列表（每行一个：YYYY-MM-DD）</label>
          <textarea id="holidayText"></textarea>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn ghost" id="btnResetHoliday">恢复默认</button>
          <button class="btn" id="btnSaveHoliday">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== JS：完全沿用之前逻辑（未改动核心计算与流程）===== -->
  <script>
/* ========== 数据与规则 ========== */

const STORAGE_KEY = "tl_emg_cases_v2";
const HOLIDAY_KEY = "tl_emg_holidays_v1";

const STAGES = [
  { id: 1, name: "立案" },
  { id: 2, name: "调查取证" },
  { id: 3, name: "集体讨论完成" },
  { id: 4, name: "处罚事先告知" },
  { id: 5, name: "作出处罚决定" },
  { id: 6, name: "送达处罚决定书" },
  { id: 7, name: "罚款缴纳" },
  { id: 8, name: "案件结案" },
  { id: 9, name: "案卷立卷" },
  { id: 10, name: "案卷归档" }
];

const DOCS = [
  "案卷封面（正卷）",
  "卷内目录",
  "行政处罚决定书",
  "立案审批表",
  "案件处理呈批表",
  "行政处罚集体讨论记录",
  "行政处罚事先告知书",
  "送达回执（含决定书送达）",
  "罚款收据/缴纳凭证",
  "现场检查记录",
  "询问通知书/询问笔录",
  "责令限期整改/整改复查意见",
  "证据材料（按形成时间顺序）",
  "其他相关文书",
  "结案审批表"
];

let currentId = null;
let CASES = loadCases();

function defaultHolidays(){
  return [
    "2025-01-01",
    "2025-02-01","2025-02-02","2025-02-03","2025-02-04","2025-02-05","2025-02-06","2025-02-07",
    "2025-04-04","2025-04-05","2025-04-06",
    "2025-05-01","2025-05-02","2025-05-03","2025-05-04","2025-05-05",
    "2025-06-01","2025-06-02",
    "2025-09-15","2025-09-16","2025-09-17",
    "2025-10-01","2025-10-02","2025-10-03","2025-10-04","2025-10-05","2025-10-06","2025-10-07",
    "2026-01-01","2026-01-02","2026-01-03",
    "2026-02-17","2026-02-18","2026-02-19","2026-02-20","2026-02-21","2026-02-22","2026-02-23",
    "2026-03-21",
    "2026-04-22","2026-04-23","2026-04-24",
    "2026-05-01","2026-05-02","2026-05-03","2026-05-04","2026-05-05",
    "2026-06-09","2026-06-10",
    "2026-07-31","2026-08-01","2026-08-02",
    "2026-09-17","2026-09-18",
    "2026-10-01","2026-10-02","2026-10-03","2026-10-04","2026-10-05","2026-10-06","2026-10-07"
  ];
}
function loadHolidays(){
  const raw = localStorage.getItem(HOLIDAY_KEY);
  if(!raw) return defaultHolidays();
  const arr = raw.split("\n").map(s=>s.trim()).filter(Boolean);
  return arr.length ? arr : defaultHolidays();
}
let HOLIDAYS = loadHolidays();

function pad(n){ return String(n).padStart(2,"0"); }
function fmt(d){
  const dt = new Date(d);
  return `${dt.getFullYear()}-${pad(dt.getMonth()+1)}-${pad(dt.getDate())}`;
}
function parseDate(s){
  if(!s) return null;
  const d = new Date(s + "T00:00:00");
  return isNaN(d) ? null : d;
}
function addDays(dateStr, days){
  const d = parseDate(dateStr);
  if(!d) return null;
  d.setDate(d.getDate() + days);
  return fmt(d);
}
function diffDays(toDateStr){
  const end = parseDate(toDateStr);
  if(!end) return null;
  const today = new Date();
  const t0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());
  const e0 = new Date(end.getF
