<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>æ‰˜é‡Œå¿åº”æ€¥ç®¡ç†å±€ï½œæ¡ˆä»¶äº‘ç«¯åä½œå¹³å°</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@vikadata/vika@latest/dist/vika.browser.js"></script>

  <style>
    /* === æ ¸å¿ƒè§†è§‰ï¼šClean Enterprise v2.0 (äº‘ç«¯ç‰ˆè“ç´«é…è‰²) === */
    :root {
      --primary: #4f46e5;       /* é›è“ï¼šä»£è¡¨äº‘ç«¯/äº’è” */
      --primary-hover: #4338ca;
      --primary-light: #eef2ff;
      --danger: #dc2626; --danger-bg: #fef2f2;
      --warning: #d97706; --warning-bg: #fffbeb;
      --success: #059669; --success-bg: #ecfdf5;
      --bg-body: #f1f5f9;
      --surface: #ffffff;
      --text-main: #1e293b; --text-muted: #64748b;
      --border: #e2e8f0;
      --radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06);
    }
    
    * { box-sizing: border-box; outline: none; }
    body { margin: 0; font-family: "Microsoft YaHei", sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.5; padding-bottom: 40px; }

    .app-wrap { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* é¡¶éƒ¨æ  */
    .header {
      background: var(--surface); padding: 16px 24px; border-radius: var(--radius);
      box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 24px; border-top: 4px solid var(--primary);
    }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon { 
      width: 42px; height: 42px; background: linear-gradient(135deg, #4f46e5, #9333ea); 
      color: #fff; border-radius: 10px; display: grid; place-items: center; font-weight: 900; font-size: 18px;
    }
    .brand-text h1 { margin: 0; font-size: 18px; font-weight: 800; color: #1e293b; }
    .online-badge { 
      font-size: 12px; background: #ecfdf5; color: #059669; padding: 2px 8px; border-radius: 99px; border: 1px solid #a7f3d0; margin-left: 8px; display: inline-flex; align-items: center; gap: 4px;
    }
    .online-badge::before { content:""; width:6px; height:6px; background:#059669; border-radius:50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:0.4} 100%{opacity:1} }

    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-card { background: var(--surface); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); }
    .stat-t { font-size: 13px; color: var(--text-muted); margin-bottom: 6px; font-weight: 600; }
    .stat-v { font-size: 26px; font-weight: 800; letter-spacing: -0.5px; }

    /* è¡¨æ ¼åŒºåŸŸ */
    .main-card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; border: 1px solid var(--border); }
    .toolbar { padding: 16px; border-bottom: 1px solid var(--border); display: flex; gap: 12px; flex-wrap: wrap; background: #f8fafc; }
    
    .search-inp { flex: 1; min-width: 200px; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; transition: 0.2s; }
    .search-inp:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
    
    .filter-sel { padding: 10px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-size: 14px; }

    .table-box { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; min-width: 1000px; }
    th { background: #f1f5f9; text-align: left; padding: 14px 16px; font-size: 12px; color: var(--text-muted); font-weight: 700; white-space: nowrap; }
    td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; color: #334155; vertical-align: middle; }
    tr:hover td { background: #f8fafc; }

    /* çŠ¶æ€æ ‡ç­¾ */
    .tag { display: inline-flex; padding: 4px 10px; border-radius: 99px; font-size: 12px; font-weight: 700; line-height: 1; }
    .tag.blue { background: var(--primary-light); color: var(--primary); }
    .tag.red { background: var(--danger-bg); color: var(--danger); }
    .tag.orange { background: var(--warning-bg); color: var(--warning); }
    .tag.purple { background: #f3e8ff; color: #7e22ce; border: 1px solid #d8b4fe; } /* äº‹æ•…æ¡ˆä»¶ä¸“ç”¨ */

    /* æŒ‰é’® */
    .btn { display: inline-flex; align-items: center; justify-content: center; padding: 10px 18px; border-radius: 8px; border: none; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; gap: 6px; }
    .btn.primary { background: var(--primary); color: #fff; box-shadow: 0 2px 5px rgba(79, 70, 229, 0.3); }
    .btn.primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn.outline { background: #fff; border: 1px solid var(--border); color: var(--text-main); }
    .btn.outline:hover { background: #f8fafc; border-color: #cbd5e1; }
    .btn.sm { padding: 6px 12px; font-size: 12px; }

    /* å¼¹çª— */
    .modal-mask { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 99; display: none; place-items: center; padding: 20px; }
    .modal-mask.show { display: grid; }
    .modal { background: #fff; width: 100%; max-width: 850px; border-radius: 16px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-head { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: #fff; z-index: 10; }
    .modal-body { padding: 24px; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-item label { display: block; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 6px; }
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .form-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

    /* Loading é®ç½© */
    #loading { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 999; display: grid; place-items: center; font-weight: bold; color: var(--primary); }
    .hidden { display: none !important; }

    /* Toast */
    .toast-box { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
    .toast { background: #fff; padding: 12px 16px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 4px solid var(--primary); font-size: 14px; font-weight: 600; animation: slideIn 0.3s; }
    @keyframes slideIn { from{transform:translateX(100%)} to{transform:translateX(0)} }
  </style>
</head>
<body>

  <div id="loading">æ­£åœ¨è¿æ¥äº‘ç«¯æ•°æ®åº“...</div>

  <div class="toast-box" id="toastBox"></div>

  <div class="app-wrap">
    <header class="header">
      <div class="brand">
        <div class="brand-icon">äº‘</div>
        <div class="brand-text">
          <h1>æ¡ˆä»¶äº‘ç«¯åä½œå¹³å° <span class="online-badge">Online</span></h1>
          <div style="font-size:12px;color:#64748b;margin-top:2px">æ‰˜é‡Œå¿åº”æ€¥ç®¡ç†å±€ï½œå¤šåœ°å®æ—¶åŒæ­¥</div>
        </div>
      </div>
      <div style="display:flex;gap:10px">
        <button class="btn outline" onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <button class="btn outline" onclick="exportExcel()">ğŸ“¥ å¯¼å‡ºExcel</button>
        <button class="btn primary" onclick="openNewCase()">ï¼‹ æ–°å¢æ¡ˆä»¶</button>
      </div>
    </header>

    <div class="stats-row">
      <div class="stat-card"><div class="stat-t">æ¡ˆä»¶æ€»æ•°</div><div class="stat-v" id="s_total">-</div></div>
      <div class="stat-card" style="border-left:4px solid var(--danger)"><div class="stat-t">å·²é€¾æœŸ</div><div class="stat-v" style="color:var(--danger)" id="s_over">-</div></div>
      <div class="stat-card" style="border-left:4px solid #7e22ce"><div class="stat-t">äº‹æ•…æ¡ˆä»¶(60æ—¥)</div><div class="stat-v" style="color:#7e22ce" id="s_acc">-</div></div>
      <div class="stat-card" style="border-left:4px solid var(--success)"><div class="stat-t">æ­£å¸¸æ¨è¿›</div><div class="stat-v" style="color:var(--success)" id="s_ok">-</div></div>
    </div>

    <div class="main-card">
      <div class="toolbar">
        <input class="search-inp" id="q_search" placeholder="ğŸ” æœç´¢ï¼šç¼–å· / ä¼ä¸š / åŠæ¡ˆäºº..." oninput="renderTable()">
        <select class="filter-sel" id="q_type" onchange="renderTable()">
          <option value="">å…¨éƒ¨ç±»å‹</option>
          <option value="çŸ¿å±±">çŸ¿å±±</option>
          <option value="å±åŒ–">å±åŒ–</option>
          <option value="å·¥è´¸">å·¥è´¸</option>
          <option value="çƒŸèŠ±çˆ†ç«¹">çƒŸèŠ±çˆ†ç«¹</option>
          <option value="äº‹æ•…æ¡ˆä»¶">äº‹æ•…æ¡ˆä»¶</option>
        </select>
        <select class="filter-sel" id="q_status" onchange="renderTable()">
          <option value="">å…¨éƒ¨çŠ¶æ€</option>
          <option value="normal">æ­£å¸¸</option>
          <option value="warning">ä¸´æœŸ (â‰¤7å¤©)</option>
          <option value="overdue">é€¾æœŸ</option>
        </select>
      </div>
      <div class="table-box">
        <table>
          <thead>
            <tr>
              <th width="25%">ä¼ä¸šä¸ç¼–å·</th>
              <th width="10%">ç±»å‹</th>
              <th width="10%">åŠæ¡ˆäºº</th>
              <th width="15%">å½“å‰è¿›åº¦</th>
              <th width="15%">æ³•å®šæˆªæ­¢</th>
              <th width="10%">å‰©ä½™å¤©æ•°</th>
              <th width="15%" style="text-align:right">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="modal-mask" id="detailModal">
    <div class="modal">
      <div class="modal-head">
        <h3 style="margin:0;font-size:18px">æ¡ˆä»¶è¯¦æƒ…</h3>
        <button class="btn outline sm" onclick="closeModal()">å…³é—­</button>
      </div>
      <div class="modal-body">
        
        <div style="background:#f8fafc;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid #e2e8f0">
          <div class="form-grid">
            <div class="form-item"><label>æ¡ˆä»¶ç¼–å·</label><input class="form-input" id="i_no" placeholder="æ‰˜åº”æ€¥ç½šã€”2025ã€•xxå·"></div>
            <div class="form-item"><label>ä¼ä¸šåç§°</label><input class="form-input" id="i_name"></div>
            <div class="form-item">
              <label>ä¼ä¸šç±»å‹</label>
              <select class="form-input" id="i_type" onchange="handleTypeChange()">
                <option value="çŸ¿å±±">çŸ¿å±±</option>
                <option value="å±åŒ–">å±åŒ–</option>
                <option value="å·¥è´¸">å·¥è´¸</option>
                <option value="çƒŸèŠ±çˆ†ç«¹">çƒŸèŠ±çˆ†ç«¹</option>
                <option value="äº‹æ•…æ¡ˆä»¶">äº‹æ•…æ¡ˆä»¶ (60æ—¥é™)</option>
              </select>
            </div>
            <div class="form-item"><label>åŠæ¡ˆäººå‘˜</label><input class="form-input" id="i_handler"></div>
            <div class="form-item"><label>ç«‹æ¡ˆæ—¥æœŸ</label><input type="date" class="form-input" id="i_date"></div>
            <div class="form-item">
              <label>åŠæ¡ˆæœŸé™</label>
              <select class="form-input" id="i_limit">
                <option value="90">90æ—¥ (ä¸€èˆ¬ç¨‹åº)</option>
                <option value="180">180æ—¥ (å»¶é•¿)</option>
              </select>
              <div id="acc_hint" style="font-size:12px;color:red;margin-top:4px;display:none">âš ï¸ äº‹æ•…æ¡ˆä»¶å¼ºåˆ¶é”å®š60æ—¥</div>
            </div>
          </div>
          <div style="margin-top:20px;text-align:right;display:flex;justify-content:flex-end;gap:10px">
              <button class="btn primary" style="background:var(--danger)" onclick="deleteCase()" id="btn_del">åˆ é™¤æ¡ˆä»¶</button>
              <button class="btn primary" onclick="saveCase()">ğŸ’¾ ä¿å­˜åŸºæœ¬ä¿¡æ¯</button>
          </div>
        </div>

        <h4 style="margin:0 0 10px 0;border-left:4px solid var(--primary);padding-left:10px">è¿›åº¦è¿½è¸ª</h4>
        <div style="background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:15px">
           <div style="display:flex;gap:10px;margin-bottom:15px">
             <div style="padding:8px 12px;background:#eef2ff;color:#4f46e5;border-radius:6px;font-weight:bold;font-size:14px">
               å½“å‰é˜¶æ®µï¼š<span id="view_stage">ç«‹æ¡ˆ</span>
             </div>
             <button class="btn outline sm" onclick="updateProgress()">â• æ›´æ–°è‡³ä¸‹ä¸€é˜¶æ®µ</button>
           </div>
           
           <div id="timeline_box" style="font-size:14px;color:#334155;max-height:200px;overflow-y:auto"></div>
        </div>

        <div style="margin-top:20px;padding:12px;background:#fffbeb;color:#b45309;font-size:13px;border-radius:8px;border:1px solid #fcd34d">
          âš ï¸ <b>äº‘ç«¯ç‰ˆé™åˆ¶æç¤ºï¼š</b><br>
          ç”±äºä½¿ç”¨å…è´¹äº‘æ•°æ®åº“ï¼Œæœ¬ç‰ˆæœ¬ä»…åŒæ­¥æ–‡å­—ä¿¡æ¯ï¼ˆæ¡ˆä»¶å°è´¦ã€è¿›åº¦ã€æ—¶é™ï¼‰ã€‚<br>
          å¤§ä½“ç§¯çš„æ‰§æ³•æ–‡ä¹¦ã€è§†é¢‘è¯æ®ï¼Œè¯·åœ¨å•ä½å†…ç½‘ç”µè„‘å­˜æ¡£ï¼Œæˆ–é€šè¿‡å¾®ä¿¡/é’‰é’‰å•ç‹¬ä¼ è¾“ã€‚
        </div>

      </div>
    </div>
  </div>

<script>
/**
 * =======================================================
 * âš ï¸ é…ç½®åŒºï¼šå·²å¡«å…¥ä½ çš„ç»´æ ¼è¡¨ Token å’Œ ID
 * =======================================================
 */
const VIKA_TOKEN = 'uskiO2vJEiSUFADER9XIlEd';      // ä½ çš„Token
const DATASHEET_ID = 'dstxQf2SXq5boYq549';     // ä½ çš„è¡¨ID

// æ£€æŸ¥æ˜¯å¦é…ç½®
if(!VIKA_TOKEN || !DATASHEET_ID) {
  alert("âš ï¸ è¯·å…ˆåœ¨ HTML ä»£ç ä¸­å¡«å…¥ VIKA_TOKEN å’Œ DATASHEET_IDï¼\n\nè¯·ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€æ­¤æ–‡ä»¶è¿›è¡Œç¼–è¾‘ã€‚");
}

// åˆå§‹åŒ– API
const vika = Vika.auth({ token: VIKA_TOKEN });
const datasheet = vika.datasheet(DATASHEET_ID);

// å…¨å±€æ•°æ®ç¼“å­˜
let ALL_CASES = [];
let CURRENT_ID = null; // å½“å‰ç¼–è¾‘çš„ recordId (ç»´æ ¼è¡¨çš„ID)
let CURRENT_DATA = null; // å½“å‰ç¼–è¾‘çš„å®Œæ•´æ•°æ®å¯¹è±¡

const STAGES = [
  {id:1,n:"ç«‹æ¡ˆç™»è®°/äº‹æ•…å‘ç”Ÿ"},{id:2,n:"è°ƒæŸ¥å–è¯"},{id:3,n:"äº‹å…ˆå‘ŠçŸ¥"},
  {id:4,n:"å†³å®šä½œå‡º/æŠ¥å‘Šæäº¤"},{id:5,n:"é€è¾¾æ‰§è¡Œ"},{id:6,n:"ç»“æ¡ˆå½’æ¡£"}
];

// === æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ===

// 1. è·å–æ•°æ® (Read)
async function refreshData() {
  showLoading(true);
  try {
    const res = await datasheet.records.query({ pageSize: 1000 });
    if(res.success) {
      ALL_CASES = res.data.records.map(rec => {
        // æˆ‘ä»¬çš„ç­–ç•¥ï¼šæ‰€æœ‰å¤æ‚æ•°æ®éƒ½å­˜åœ¨ 'data_json' è¿™ä¸€åˆ—æ–‡æœ¬é‡Œ
        // ç¬¬ä¸€åˆ— 'title' å­˜æ¡ˆä»¶ç¼–å·æ–¹ä¾¿è‚‰çœ¼çœ‹
        let parsed = {};
        try {
          parsed = JSON.parse(rec.fields['data_json']);
        } catch(e) { parsed = {} }
        
        return {
          _id: rec.recordId, // ç»´æ ¼è¡¨çš„è¡ŒIDï¼Œç”¨äºä¿®æ”¹
          ...parsed
        };
      }).filter(c => c.caseNumber); // è¿‡æ»¤ç©ºè¡Œ

      renderTable();
      calcStats();
      toast('æ•°æ®å·²ä»äº‘ç«¯åŒæ­¥');
    } else {
      toast('åŒæ­¥å¤±è´¥: ' + res.message, 'error');
    }
  } catch(e) {
    console.error(e);
    toast('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ', 'error');
  }
  showLoading(false);
}

// 2. ä¿å­˜/æ›´æ–°æ•°æ® (Create/Update)
async function saveCase() {
  const data = getFormData();
  if(!data.caseNumber || !data.entName) return toast('ç¼–å·å’Œä¼ä¸šåç§°å¿…å¡«','error');

  showLoading(true);
  try {
    // æ„é€ è¦å­˜çš„ JSON å­—ç¬¦ä¸²
    // å¦‚æœæ˜¯ç¼–è¾‘ï¼Œä¿ç•™åŸæ¥çš„ timeline å’Œ stage
    if(CURRENT_DATA) {
      data.stage = CURRENT_DATA.stage;
      data.timeline = CURRENT_DATA.timeline;
      data.createTime = CURRENT_DATA.createTime;
    } else {
      // æ–°å¢
      data.stage = 1;
      data.timeline = [{t: todayStr(), txt: 'æ¡ˆä»¶åˆ›å»º(äº‘ç«¯ç™»è®°)'}];
      data.createTime = new Date().toISOString();
    }
    
    const jsonStr = JSON.stringify(data);

    if(CURRENT_ID) {
      // æ›´æ–°
      await datasheet.records.update([{
        recordId: CURRENT_ID,
        fields: {
          'title': data.caseNumber, // ç¬¬ä¸€åˆ—
          'data_json': jsonStr      // ç¬¬äºŒåˆ—å­˜æ‰€æœ‰æ•°æ®
        }
      }]);
      toast('ä¿®æ”¹å·²ä¿å­˜è‡³äº‘ç«¯');
    } else {
      // æ–°å¢
      await datasheet.records.create([{
        fields: {
          'title': data.caseNumber,
          'data_json': jsonStr
        }
      }]);
      toast('æ–°æ¡ˆä»¶å·²ä¸Šä¼ äº‘ç«¯');
    }
    closeModal();
    refreshData();
  } catch(e) {
    console.error(e);
    toast('ä¿å­˜å¤±è´¥','error');
  }
  showLoading(false);
}

// 3. åˆ é™¤æ•°æ® (Delete)
async function deleteCase() {
  if(!CURRENT_ID) return;
  if(!confirm('âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦ä»äº‘æ•°æ®åº“å½»åº•åˆ é™¤æ­¤æ¡ˆä»¶å—ï¼Ÿæ‰€æœ‰åŒäº‹å°†æ— æ³•å†æŸ¥çœ‹ã€‚')) return;
  
  showLoading(true);
  try {
    await datasheet.records.delete([CURRENT_ID]);
    toast('æ¡ˆä»¶å·²åˆ é™¤');
    closeModal();
    refreshData();
  } catch(e) {
    toast('åˆ é™¤å¤±è´¥','error');
  }
  showLoading(false);
}

// 4. è¿›åº¦æ›´æ–°
async function updateProgress() {
  if(!CURRENT_ID || !CURRENT_DATA) return toast('è¯·å…ˆä¿å­˜åŸºæœ¬ä¿¡æ¯','error');
  if(CURRENT_DATA.stage >= 6) return toast('å·²æ˜¯æœ€åé˜¶æ®µ','error');

  const note = prompt("è¯·è¾“å…¥è¿›åº¦è¯´æ˜/å¤‡æ³¨ï¼š");
  if(note === null) return;

  CURRENT_DATA.stage += 1;
  const stageName = STAGES.find(s=>s.id === CURRENT_DATA.stage).n;
  CURRENT_DATA.timeline.push({ t: todayStr(), txt: `è¿›å…¥[${stageName}]ï¼š${note}` });
  
  // ä»…æ›´æ–° JSON å­—æ®µ
  const jsonStr = JSON.stringify(CURRENT_DATA);
  
  showLoading(true);
  await datasheet.records.update([{
    recordId: CURRENT_ID,
    fields: { 'data_json': jsonStr }
  }]);
  showLoading(false);
  
  toast('è¿›åº¦å·²æ›´æ–°');
  // åˆ·æ–°ç•Œé¢
  openDetail(CURRENT_ID); 
  renderTable(); // åå°åˆ·æ–°ä¸€ä¸‹åˆ—è¡¨
}

// === è¾…åŠ©åŠŸèƒ½ ===

function getFormData() {
  return {
    caseNumber: val('i_no'),
    entName: val('i_name'),
    entType: val('i_type'),
    handler: val('i_handler'),
    registerDate: val('i_date'),
    decisionLimit: val('i_limit')
  };
}

function renderTable() {
  const q = val('q_search').toLowerCase();
  const type = val('q_type');
  const status = val('q_status');
  const tbody = document.getElementById('tableBody');
  
  const list = ALL_CASES.filter(c => {
    const txt = (c.caseNumber + c.entName + c.handler).toLowerCase();
    const matchQ = txt.includes(q);
    const matchType = !type || c.entType === type;
    
    // çŠ¶æ€ç­›é€‰
    const dl = calcDeadLine(c);
    let matchStatus = true;
    if(status === 'overdue') matchStatus = dl.days <= 0 && c.stage < 6;
    if(status === 'warning') matchStatus = dl.days > 0 && dl.days <= 7 && c.stage < 6;
    if(status === 'normal') matchStatus = dl.days > 7 && c.stage < 6;
    
    return matchQ && matchType && matchStatus;
  });

  if(!list.length) { tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:30px;color:#94a3b8">æ— åŒ¹é…æ•°æ®</td></tr>`; return; }

  tbody.innerHTML = list.map(c => {
    const dl = calcDeadLine(c);
    const stageInfo = STAGES.find(s=>s.id === (c.stage||1));
    
    let daysHtml = '';
    if(c.stage >= 6) daysHtml = `<span class="tag blue">å·²ç»“æ¡ˆ</span>`;
    else if(dl.days <= 0) daysHtml = `<span class="tag red">é€¾æœŸ ${Math.abs(dl.days)} å¤©</span>`;
    else if(dl.days <= 7) daysHtml = `<span class="tag orange">å‰©ä½™ ${dl.days} å¤©</span>`;
    else daysHtml = `<span class="tag blue">å‰©ä½™ ${dl.days} å¤©</span>`;

    const typeTag = c.entType === 'äº‹æ•…æ¡ˆä»¶' ? 'tag purple' : 'tag' + (c.entType==='çŸ¿å±±'?' orange':' blue');
    
    return `<tr>
      <td>
        <div style="font-weight:bold">${c.entName}</div>
        <div style="font-size:12px;color:#64748b">${c.caseNumber}</div>
      </td>
      <td><span class="${typeTag}" style="background:#f1f5f9;color:#475569">${c.entType}</span></td>
      <td>${c.handler}</td>
      <td><b style="color:var(--primary)">${stageInfo ? stageInfo.n : '-'}</b></td>
      <td>${dl.date} ${dl.isAccident?'<br><span style="font-size:10px;color:red">äº‹æ•…60æ—¥é™</span>':''}</td>
      <td>${daysHtml}</td>
      <td style="text-align:right">
        <button class="btn outline sm" onclick="openDetail('${c._id}')">è¯¦æƒ…</button>
      </td>
    </tr>`;
  }).join('');
}

function openDetail(id) {
  CURRENT_ID = id;
  const c = ALL_CASES.find(x => x._id === id);
  CURRENT_DATA = c;

  // å¡«å……è¡¨å•
  document.getElementById('i_no').value = c.caseNumber;
  document.getElementById('i_name').value = c.entName;
  document.getElementById('i_type').value = c.entType;
  document.getElementById('i_handler').value = c.handler;
  document.getElementById('i_date').value = c.registerDate;
  document.getElementById('i_limit').value = c.decisionLimit;
  
  handleTypeChange(); // è§¦å‘äº‹æ•…é”å®šé€»è¾‘
  
  // æ¸²æŸ“æ—¶é—´è½´
  const tlBox = document.getElementById('timeline_box');
  if(c.timeline && c.timeline.length) {
    tlBox.innerHTML = c.timeline.map(t => 
      `<div style="margin-bottom:8px;padding-bottom:8px;border-bottom:1px dashed #e2e8f0">
         <span style="color:#64748b;font-size:12px;margin-right:8px">${t.t}</span>
         <span>${t.txt}</span>
       </div>`
    ).join('');
  } else {
    tlBox.innerHTML = '<div style="color:#94a3b8;font-size:12px;text-align:center">æš‚æ— è®°å½•</div>';
  }

  document.getElementById('view_stage').textContent = STAGES.find(s=>s.id === (c.stage||1))?.n;
  document.getElementById('btn_del').style.display = 'inline-flex';
  
  document.getElementById('detailModal').classList.add('show');
}

function openNewCase() {
  CURRENT_ID = null;
  CURRENT_DATA = null;
  
  // æ¸…ç©ºè¡¨å•
  ['i_no','i_name','i_handler'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('i_date').value = todayStr();
  document.getElementById('i_type').value = 'çŸ¿å±±';
  document.getElementById('i_limit').value = '90';
  handleTypeChange();
  
  document.getElementById('timeline_box').innerHTML = 'æ–°æ¡ˆä»¶æš‚æ— è®°å½•';
  document.getElementById('view_stage').textContent = 'å¾…ä¿å­˜';
  document.getElementById('btn_del').style.display = 'none';
  
  document.getElementById('detailModal').classList.add('show');
}

function handleTypeChange() {
  const t = val('i_type');
  const isAcc = t === 'äº‹æ•…æ¡ˆä»¶';
  const lim = document.getElementById('i_limit');
  const hint = document.getElementById('acc_hint');
  
  if(isAcc) {
    lim.value = '60'; // è¿™é‡Œçš„valueä»…ç”¨äºæ˜¾ç¤ºï¼Œå®é™…è®¡ç®—é€»è¾‘åœ¨ calcDeadLine
    lim.disabled = true;
    hint.style.display = 'block';
  } else {
    lim.disabled = false;
    hint.style.display = 'none';
  }
}

function calcDeadLine(c) {
  if(!c.registerDate) return { days:0, date:'-', isAccident:false };
  const isAcc = c.entType === 'äº‹æ•…æ¡ˆä»¶';
  const limit = isAcc ? 60 : parseInt(c.decisionLimit || 90);
  
  const start = new Date(c.registerDate);
  const end = new Date(start);
  end.setDate(start.getDate() + limit);
  
  const now = new Date(); now.setHours(0,0,0,0);
  // è‡ªç„¶æ—¥è®¡ç®—
  const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
  const dateStr = end.toISOString().split('T')[0];
  
  return { days: diff, date: dateStr, isAccident: isAcc };
}

function calcStats() {
  let total=ALL_CASES.length, over=0, acc=0, ok=0;
  ALL_CASES.forEach(c => {
    if(c.entType === 'äº‹æ•…æ¡ˆä»¶') acc++;
    if(c.stage >= 6) return;
    const d = calcDeadLine(c).days;
    if(d <= 0) over++; else ok++;
  });
  document.getElementById('s_total').textContent = total;
  document.getElementById('s_over').textContent = over;
  document.getElementById('s_acc').textContent = acc;
  document.getElementById('s_ok').textContent = ok;
}

// å¯¼å‡º Excel
function exportExcel() {
  if(!ALL_CASES.length) return toast('æ— æ•°æ®å¯å¯¼å‡º','error');
  const rows = ALL_CASES.map(c => {
    const dl = calcDeadLine(c);
    return {
      "æ¡ˆä»¶ç¼–å·": c.caseNumber,
      "ä¼ä¸šåç§°": c.entName,
      "ç±»å‹": c.entType,
      "ç«‹æ¡ˆæ—¥æœŸ": c.registerDate,
      "æˆªæ­¢æ—¥æœŸ": dl.date,
      "å‰©ä½™å¤©æ•°": c.stage>=6 ? 'å·²ç»“æ¡ˆ' : dl.days,
      "å½“å‰é˜¶æ®µ": STAGES.find(s=>s.id===c.stage)?.n
    }
  });
  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "æ¡ˆä»¶å°è´¦");
  XLSX.writeFile(wb, `æ‰˜é‡Œå¿åº”æ€¥_æ¡ˆä»¶äº‘å°è´¦_${todayStr()}.xlsx`);
}

// é€šç”¨å·¥å…·
function val(id) { return document.getElementById(id).value; }
function todayStr() { return new Date().toISOString().split('T')[0]; }
function closeModal() { document.getElementById('detailModal').classList.remove('show'); }
function showLoading(show) { document.getElementById('loading').className = show ? '' : 'hidden'; }
function toast(msg, type='success') {
  const t = document.createElement('div');
  t.className = 'toast';
  if(type==='error') { t.style.borderLeftColor = '#dc2626'; t.innerHTML = 'âŒ ' + msg; }
  else { t.innerHTML = 'âœ… ' + msg; }
  document.getElementById('toastBox').appendChild(t);
  setTimeout(()=>t.remove(), 3000);
}

// å¯åŠ¨
refreshData();
</script>
</body>
</html>
